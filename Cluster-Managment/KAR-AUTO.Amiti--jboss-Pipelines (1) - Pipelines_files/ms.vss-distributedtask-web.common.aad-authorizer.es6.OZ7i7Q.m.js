"use strict";define("DistributedTask/Common/AadAuthorizer",["require","exports","DistributedTask/Client/RestClient/TaskAgent","VSS/Platform/Feature"],(function(t,e,o,i){var n,s;n=e.Resources={},e.Resources.CancelButtonText="Cancel",e.Resources.CouldNotAuthenticateAAD="Could not authenticate to Azure Active Directory. If a popup blocker is enabled in the browser, disable it and try again.",e.Resources.EnvironmentSecurity="Environment security",e.Resources.NoPermissionsToManageSecurity="You do not have sufficient permissions to manage environment security.",e.Resources.OkButtonText="OK",e.Resources.SpnAuthorizationFailedError="Authorization failed",function(t){function o(t,e,o){return function(){if(void 0===o)return e.apply(t,arguments);{let i=Array.prototype.slice.call(arguments,0);return o instanceof Array?i=i.concat(o):i.push(o),e.apply(t,i)}}}s=e.DelayedFunction={},e.DelayedFunction.delegate=o;e.DelayedFunction.DelayedFunction=class{constructor(t,e,i,n,s){this._invokeOnCooldownComplete=!1,this._interval=e,this._name=i,this._func=o(t,n,s)}start(){let t=this;this._timeoutHandle||(this._timeoutHandle=window.setTimeout((function(){delete t._timeoutHandle;try{t._invoke.call(t)}finally{}}),this._interval))}reset(){this.cancel(),this.start()}cancel(t=!1){this._timeoutHandle&&(window.clearTimeout(this._timeoutHandle),delete this._timeoutHandle),t&&this.clearCooldown(),this._invokeOnCooldownComplete=!1}clearCooldown(t=!0){this._cooldownHandle&&(window.clearTimeout(this._cooldownHandle),delete this._cooldownHandle),!t&&this.invokeOnCooldownComplete&&this.invokeNow()}extendCooldown(){this._startCooldown()}invokeNow(){this.cancel(),this._invoke()}setDelay(t){this._interval=t}setMethod(t,e,i){this._func=o(t,e,i)}isPending(){return!!this._timeoutHandle}isCoolingDown(){return!!this._cooldownHandle}invokeOnCooldownComplete(){this._invokeOnCooldownComplete=!0}_invoke(){this._func(),this._startCooldown()}_startCooldown(){this._cooldownHandle&&window.clearTimeout(this._cooldownHandle),this._cooldownHandle=window.setTimeout((()=>{delete this._cooldownHandle,this._invokeOnCooldownComplete&&(this.invokeNow(),this._invokeOnCooldownComplete=!1)}),this._interval)}}}(),function(t){e.AadAuthorizer={};e.AadAuthorizer.AadAuthorizer=class{constructor(t){this._pageContext=t,this._distributedTaskClient=(0,o.getTaskAgentClient)(t)}getAccessTokenKey(t,e,o,i,n){return new Promise(((o,s)=>{if(i)o(i);else if(t){let i=t.id;void 0===typeof window&&s("");let a=window.location.origin+t.url+"/_admin/_services/completecallbackbyauthcode";null!=n&&(a+="?endpointId="+n+"&projectId="+i),this.authorize(e,a,3,"",!0).then((t=>{o(t)}),(t=>{s(t)}))}else s("")}))}authorize(t,e,o,n,s,a){return new Promise(((r,l)=>{if(this._pageContext.getService("IVssPageService").getData().isDevfabric&&(0,i.isFeatureFlagEnabled)(this._pageContext,"VisualStudio.Services.UseProdAzureResourcesOnDevFabric",!1))return r("");this._getAadOAuthLoginUrl(t,e,o,n,s,a).then((t=>{if(t=t.value||t,this.authWindow=window.open(t,"","width = 960, height = 600, location = true, menubar = false, toolbar = false"),""!==n)return r("");this._pollAuthWindow().then((t=>r(t)),(t=>l(t)))}),(t=>l(t)))}))}_pollAuthWindow(){return new Promise(((t,e)=>{this._monitorAuthProgress=new s.DelayedFunction(this,1e3,"monitorAuthProgress",(()=>{try{if(this.authWindow)if(this.authWindow.closed)e(""),this._cleanupAuthWindow();else try{this.authWindow.vstsaadoauthcompleted?(this.authWindow.vstsaadoautherrormessage?e(this.authWindow.vstsaadoautherrormessage):this.authWindow.vstsaadoauthaccesstokenkey?t(this.authWindow.vstsaadoauthaccesstokenkey):e(n.SpnAuthorizationFailedError),this._cleanupAuthWindow()):this._monitorAuthProgress.reset()}catch(t){this._monitorAuthProgress.reset()}else e(n.CouldNotAuthenticateAAD),this._cleanupAuthWindow()}catch(t){e(t),this._cleanupAuthWindow()}})),this._monitorAuthProgress.start()}))}_cleanupAuthWindow(){if(this.authWindow)try{this.authWindow.close(),this.authWindow=null}catch(t){}this._monitorAuthProgress&&(this._monitorAuthProgress.cancel(),delete this._monitorAuthProgress)}_getAadOAuthLoginUrl(t,e,o,i="",n=!1,s){return s?Promise.resolve(s):this._distributedTaskClient.createAadOAuthRequest(t,e,o,i,n)}}}()}),["Resources","DelayedFunction","AadAuthorizer"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-distributedtask-web.common.aad-authorizer"}}));