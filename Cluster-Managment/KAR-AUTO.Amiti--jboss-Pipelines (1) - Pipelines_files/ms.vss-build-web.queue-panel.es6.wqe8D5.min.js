"use strict";define("Build/Queue-Panel",["require","exports","Build/Flux/Action","Build/Flux/Store","Build/SourceProviders/Common","VSS/Core/Observable","VSS/Core/Util/String","VSS/Platform/Feature","react","VSSUI/Button","VSSUI/List","VSSUI/MessageCard","VSSUI/Observer","VSSUI/Panel","VSSUI/Resources.Input","VSSUI/Spinner","VSSUI/Status","VSSUI/Table","VSSUI/TextField","VSSUI/TooltipEx","VSSUI/Util","VSSUI/Utilities/Provider","VSSUI/FormItem","VSSUI/PickList","VSSUI/Icon","VSSUI/Link","VSSUI/Ago","VSS/Core/TimerManagement","Build/Common/Library/Legacy/Components/BranchDropdown","VSSUI/Checkbox","VSSUI/Dropdown","VSSUI/RadioButton","VSSUI/Utilities/DropdownSelection","Build/Common/Library/Resources","Build/Common/Library/Legacy/Components/ShelvesetAction","Build/Common/Library/Legacy/Stores/Queue","Build/Common/Library/SingletonManager","DistributedTask/Common/Library/AgentQueueSelector","DistributedTask/Common/Library/Sources/Queue","VSS/Platform/FPS","VSSUI/ButtonGroup","VSSUI/Header","VSSUI/Intersection"],(function(e,t,s,i,a,r,n,o,l,c,u,h,d,p,m,g,_,b,v,R,S,f,C,P,x,y,D,E,V,T,w,B,N,A,k,I,O,L,q,M,F,U,j){var H,Q,z,W,G,Y,K,$,J,X,Z,ee,te,se,ie,ae,re,ne;H=t.Resources={},t.Resources.AddDemandButton="Add demand",t.Resources.AddDemandPanelTitle="New demand",t.Resources.AddVariableButton="Add variable",t.Resources.AddVariablePanelTitle="New variable",t.Resources.AdvancedOptionsLabel="Advanced options",t.Resources.AgentSpecificationRequired="Selecting an agent specification is required",t.Resources.AgentPool="Agent pool",t.Resources.Back="Back",t.Resources.BranchLabel="Branch/tag",t.Resources.BuildQueuedMessage="Build #{0} has been queued.",t.Resources.BuildResourceNoRunsText="This build has no runs yet",t.Resources.CancelButtonText="Cancel",t.Resources.CloseButtonLabel="Close",t.Resources.ConditionFieldLabel="Condition",t.Resources.ContainerResourceNoRunsText="This repository has no images yet",t.Resources.ContainerResourceUpdateButtonText="Use selected image",t.Resources.CreateButtonText="Create",t.Resources.DeleteButtonEmptyTooltip="Delete variable",t.Resources.DeleteButtonTooltip="Delete variable '{0}'",t.Resources.DemandsEmptySecondaryText="This pipeline has no defined demands",t.Resources.DemandsLearnMore="Learn more about demands",t.Resources.DemandsManySecondaryText="{0} demands defined",t.Resources.DemandsOneSecondaryText="1 demand defined",t.Resources.DemandsTitle="Demands",t.Resources.DependsOn="Depends on: {0}",t.Resources.DisabledDueToInvalidTemplateParametersMessage="This option is unavailable while parameters are invalid",t.Resources.DuplicateVariableMessage="Variable '{0}' is already defined",t.Resources.EmptyDemandsDescription="You can add demands for this run.",t.Resources.LearnMoreMessage=" Learn more.",t.Resources.EmptyVariablesDescription="You can add variables for this run.",t.Resources.EnforcedEmptyVariablesDescription="You can't add variables for this run.",t.Resources.EqualsCondition="equals",t.Resources.ExistsCondition="exists",t.Resources.GitSourceSelectorDescription="Select a branch from the list or enter the name of a tag as refs/tags/<tagname>",t.Resources.ListItemRoleDescription="button",t.Resources.NameFieldLabel="Name",t.Resources.NoStageDependencies="No dependencies",t.Resources.NumericInputErrorMessage="Entered value must be a number",t.Resources.PipelineResourceLastRun="Last successful run (for specified branch/tags)",t.Resources.PipelineResourcePanelDescription="Select the pipeline run to use",t.Resources.PipelineRunColumnHeadingForPipelineResourcePanel="Pipeline run",t.Resources.CompletedColumnHeadingForPipelineResourcePanel="Completed",t.Resources.ProcessingYamlMessage="Processing pipeline YAML...",t.Resources.QueueButtonText="Run",t.Resources.QueuePanelDescription="Select parameters below and manually run the pipeline",t.Resources.QueuePanelTitleNoDefinition="Run pipeline",t.Resources.RepositoryResourcePanelDescription="on {0}",t.Resources.RepositoryResourceSourceLabel="Source version to use",t.Resources.RepositoryResourceUpdateButtonText="Use selected version",t.Resources.PipelineResourceUpdateButtonText="Use selected run",t.Resources.RequiredLabel="Required",t.Resources.Resources="Resources",t.Resources.ResourceCountBuildRun="1 build run",t.Resources.ResourceCountBuildRuns="{0} build runs",t.Resources.ResourceCountContainerRun="1 container image",t.Resources.ResourceCountContainerRuns="{0} container images",t.Resources.ResourceCountPackageRun="1 package run",t.Resources.ResourceCountPackageRuns="{0} package runs",t.Resources.ResourceCountPipelineRun="1 pipeline run",t.Resources.ResourceCountPipelineRuns="{0} pipeline runs",t.Resources.ResourceCountRepository="1 repository",t.Resources.ResourceCountRepostiories="{0} repositories",t.Resources.ResourcesDescriptionText="Review the resources to use with this run",t.Resources.ResourcesNoResourcesText="This pipeline has no specified resources",t.Resources.PipelineResourceNoRunsText="This pipeline has no runs yet",t.Resources.PipelineResourceSearchBarText="Search pipeline runs",t.Resources.PipelineResourceNoSearchResultsText="No run names match '{0}'",t.Resources.PackageResourceSearchBarText="Enter package version",t.Resources.ResourcesUseLatestText="Use latest version of all resources",t.Resources.StageOptionsRunAsConfigured="Run as configured",t.Resources.RunAllStages="Run all stages",t.Resources.RunWithDiagnostics="Enable system diagnostics",t.Resources.RunWithWarningsButtonText="Run anyway",t.Resources.SaveAndRunWithWarningsButtonText="Save and run anyway",t.Resources.SaveAndQueueButtonText="Save and run",t.Resources.SaveComment="Save comment",t.Resources.SecretFieldLabel="Keep this value secret",t.Resources.SingleStagePipeline="Configuration is only available for multi-stage pipelines.",t.Resources.SkippedStagesWarning="Ensure that skipped stages do not produce any artifacts required by later stages.",t.Resources.SourceVersionLabel="Source version",t.Resources.StagesToRun="Stages to run",t.Resources.StagesToRunSecondaryText="Deselect stages you want to skip for this run",t.Resources.StartingRun="Starting run...",t.Resources.TfsGitSourceSelectorDescription="Select the branch, commit, or tag",t.Resources.UnableToLoadStages="Unable to load the pipeline's stages.",t.Resources.UpdateButtonText="Update",t.Resources.UpdateDemandPanelTitle="Update demand",t.Resources.UseSelectedStages="Use selected stages",t.Resources.UpdateVariablePanelTitle="Update variable",t.Resources.ValueFieldLabel="Value",t.Resources.VariablesLearnMore="Learn more about variables",t.Resources.VariableRequiredNameMessage="Variable name is required",t.Resources.VariablesEmptySecondaryText="This pipeline has no defined variables",t.Resources.VariablesManySecondaryText="{0} variables defined",t.Resources.VariablesOneSecondaryText="1 variable defined",t.Resources.VariablesTitle="Variables",t.Resources.YamlMissingError="Encountered error(s): Could not find valid pipeline YAML file for this branch/tag",t.Resources.YamlParseError="Encountered error(s) while parsing pipeline YAML:\n{0}",function(e){Q=t.Action={};t.Action.EnableDiagnosticActionCreator=class{constructor(e){this._actionHub=e.actionHub||new i}toggleEnableDiagnostic(e){this._actionHub.toggleEnableDiagnostic.invoke(e)}};class i{constructor(){this._toggleEnableDiagnostic=new s.Action}get toggleEnableDiagnostic(){return this._toggleEnableDiagnostic}}t.Action.EnableDiagnosticActionHub=i;class a{constructor(e){this._actionHub=e.actionHub||new r}queueBuild(e){e.isYaml?this._runPipeline(e):this._queueBuild(e)}_runPipeline(e){const t=e.repositoryResources||{};t.self={refName:e.sourceBranch,version:e.sourceVersion};const s={repositories:t,pipelines:e.pipelineResources,builds:e.buildResources,containers:e.containerResources,packages:e.packageResources},i={stagesToSkip:e.stagesToSkip,resources:s,templateParameters:e.templateParameters,variables:e.variables};e.pageContext.getRestClient("IPipelinesRestClient").runPipeline(i,e.projectId,e.definitionId).then((e=>this._actionHub.buildQueued.invoke({buildId:e.id}))).catch((e=>{this._actionHub.buildQueued.invoke({buildId:void 0,message:e.message,messageSeverity:"Error"})}))}_queueBuild(e){const t={agentSpecification:e.agentSpecification,queue:{id:e.agentQueueId},definition:{id:e.definitionId},project:{id:e.projectId},sourceBranch:e.sourceBranch,sourceVersion:e.sourceVersion,reason:1,demands:e.demands,parameters:e.serializedVariables};e.pageContext.getRestClient("IBuildRestClient").queueBuild(t,e.projectId,e.ignoreWarnings).then((e=>this._actionHub.buildQueued.invoke({buildId:e.id}))).catch((e=>{const t=a._getErrorAndWarningMessage(e);this._actionHub.buildQueued.invoke({buildId:void 0,message:t.message,messageSeverity:t.severity})}))}static _getErrorAndWarningMessage(e){let t="",s="Info";if(e&&e.length>0){const i=e.filter((e=>2===e.result));i.length>0?(t=this._joinValidateResults(i),s="Error"):(t=this._joinValidateResults(e),s="Warning")}else if(e)return this._getErrorMessageFromServer(e);return{message:t,severity:s}}static _joinValidateResults(e){let t=e.map((e=>e.message));return t=t.filter((e=>!!e)),t.join(",")}static _getErrorMessageFromServer(e){let t="",s="Error";if(e&&(t=e.message||""),e&&e.serverError&&e.serverError.customProperties){let i=e.serverError.customProperties.ValidationResults;if(i&&i.length>0){const e=i.filter((e=>2===e.result));t=this._joinValidateResults(e);const a=i.filter((e=>1===e.result));a&&a.length>0&&(t=this._joinValidateResults(a),s="Warning")}}else e&&e.serverError&&0===t.length&&(t=e.serverError.message||"");return{message:t,severity:s}}}t.Action.QueueBuildActionCreator=a;class r{constructor(){this._buildQueued=new s.Action}get buildQueued(){return this._buildQueued}}t.Action.QueueBuildActionHub=r;t.Action.SourceVersionActionCreator=class{constructor(e){this._actionHub=e.actionHub||new n}updateVersion(e){this._actionHub.versionUpdated.invoke(e)}updateBranch(e){this._actionHub.branchUpdated.invoke(e)}updateTag(e){this._actionHub.tagUpdated.invoke(e)}updateShelveset(e){this._actionHub.shelvesetUpdated.invoke(e)}};class n{constructor(){this._versionUpdated=new s.Action,this._branchUpdated=new s.Action,this._shelvesetUpdated=new s.Action,this._tagUpdated=new s.Action}get versionUpdated(){return this._versionUpdated}get branchUpdated(){return this._branchUpdated}get tagUpdated(){return this._tagUpdated}get shelvesetUpdated(){return this._shelvesetUpdated}}t.Action.SourceVersionActionHub=n}(),z=t.Constants={},(ne=t.Constants.GitConstants||(t.Constants.GitConstants={})).RefsHeadsPrefix="refs/heads/",ne.RefsTagsPrefix="refs/tags/",ne.RefsPrefix="refs/",ne.ShortenedCommitHashLength=8,function(e){W=t.StoresQueueBuild={};const s="ms.vss-build-web.pipeline-run-parameters-data-provider",l="ms.vss-build-web.pipeline-resource-runs-data-provider",c="ms.vss-build-web.build-resource-runs-data-provider",u="system.debug",h="agent.diagnostic";class d extends i.Store{constructor(e){super(),this._sourceVersion="",this._shelvesetName="",this._runParametersAreLoaded=!1,this._templateParametersAreValid=new r.ObservableValue(!0),this._previousTemplateParameters={},this._errorMessage=new r.ObservableValue(""),this.updateDefinition=(e,t,s,i,a,n,o)=>{i||(this._buildDefinition=void 0),this._definitionId=e,this._enableDiagnostic=!1,this._definitionVariables=n,this._runtimeVariables=new r.ObservableArray(this._createRuntimeVariablesArray(t)),this._previousTemplateParameters=o||{},this._sourceBranch=s||"",this._sourceVersion="",this._shelvesetName="",this._sourceTag="",this._selectedQueue={},this._buildRepository=a||{},this._resetPipelineResources()},this.updateBuildDefinition=(e,t,s,i)=>{const a=e&&e.repository?e.repository.defaultBranch:"";this._buildDefinition=e,e&&e.id&&this.updateDefinition(e.id,t,a,!0,e.repository,s,i)},this.fetchBuildDefinition=()=>this._buildDefinition&&this._buildDefinition.id===this._definitionId?Promise.resolve(this._buildDefinition):this._buildClient.getDefinition(this._projectId,this._definitionId).then((e=>(this._buildDefinition=e,this._buildDefinition))),this.fetchUpdatedDefaultBranch=()=>this._buildClient.getDefinition(this._projectId,this._definitionId).then((e=>e.repository.defaultBranch)),this.fetchDemands=()=>{this._demands?this._demands.removeAll():this._demands=new r.ObservableArray([]),this.fetchBuildDefinition().then((e=>{const t=this._convertSerializedDemandToDemandData(e.demands);this._demands.value=t}),(e=>{console.log("failed to retrieve build definition: "+e)}))},this.getBuildResourceRuns=e=>this._buildResourceRuns&&this._buildResourceRuns.get(e),this.getContainerResourceRuns=e=>this._containerResourceRuns&&this._containerResourceRuns.get(e),this.getPipelineResourceRuns=e=>this._pipelineResourceRuns&&this._pipelineResourceRuns.get(e),this.getVariables=()=>this._runtimeVariables,this.updateBranchForCommit=e=>{this._sourceTag="",this._sourceBranch=e,this.emitChanged()},this.updateVariable=(e,t)=>{this._runtimeVariables.change(t,e)},this.addVariable=e=>{this._runtimeVariables.push(e)},this.deleteVariable=e=>{this._runtimeVariables.splice(e,1)},this.addDemand=e=>{this._demands.push(e)},this.deleteDemand=e=>{this._demands.splice(e,1)},this.updateDemand=e=>{this._demands.change(e.index,e)},this.updateStageOptions=e=>{this._stageOptions.value=e.map((e=>Object.assign({},e)))},this.updateRepositoryResource=e=>{if(this._repositoryResources&&e){const t=this._repositoryResources.value.findIndex((t=>t.alias===e.alias));t>-1&&this._repositoryResources.change(t,Object.assign({},e))}},this.updatePipelineResource=e=>{if(this._pipelineResources&&e){const t=this._pipelineResources.value.findIndex((t=>t.alias===e.alias));t>-1&&this._pipelineResources.change(t,Object.assign({},e))}},this.updateBuildResource=e=>{if(this._buildResources&&e){const t=this._buildResources.value.findIndex((t=>t.alias===e.alias));t>-1&&this._buildResources.change(t,Object.assign({},e))}},this.updateContainerResource=e=>{if(this._containerResources&&e){const t=this._containerResources.value.findIndex((t=>t.alias===e.alias));t>-1&&this._containerResources.change(t,Object.assign({},e))}},this.updatePackageResource=e=>{if(this._packageResources&&e){const t=this._packageResources.value.findIndex((t=>t.alias===e.alias));t>-1&&this._packageResources.change(t,Object.assign({},e))}},this.updateTemplateParameter=e=>{const t=this._templateParameters.value.findIndex((t=>t.data.name===e.data.name));if(t>-1){const s={data:e.data,value:e.value,errorMessage:this._validateTemplateParameterInput(e.data,e.value)};this._templateParameters.change(t,s),e.errorMessage!==s.errorMessage&&this._updateTemplateParametersValidity(),this._resetParameterDependentResources()}},this._createRuntimeVariablesArray=e=>{const t=[];e&&e.length>0&&e.forEach(((e,s)=>{if((0,o.isFeatureFlagEnabled)(this._pageContext,"Build2.FilterOutSystemVariables",!1)&&(e.name.startsWith("system.")||e.name.startsWith(h))){if(!e.variable.disableDelete)return;{const t=this._definitionVariables&&this._definitionVariables[e.name];t&&(e.variable.value=t.value)}}t.push({index:s,name:e.name,value:e.variable.value,isSecret:e.variable.isSecret,disableDelete:e.variable.disableDelete})}));const s=t.findIndex((e=>e.name===u&&"true"===e.value)),i=t.findIndex((e=>e.name===h&&"true"===e.value));if(s>-1&&i>-1){const e=t[s],a=t[i];if(e.disableDelete){const t=this._definitionVariables&&this._definitionVariables["system.debug"];t&&(e.value=t.value)}else t.splice(s,1);if(a.disableDelete){const e=this._definitionVariables&&this._definitionVariables["agent.diagnostic"];e&&(a.value=e.value)}else{const e=t.findIndex((e=>e.name===h));t.splice(e,1)}this._handleToggleEnableDiagnostic(!0)}return t},this._isGit=e=>{const t=e.toLowerCase();return t===a.RepositoryTypes.Bitbucket.toLowerCase()||t===a.RepositoryTypes.ExternalGit.toLowerCase()||t===a.RepositoryTypes.GitHub.toLowerCase()||t===a.RepositoryTypes.GitHubEnterprise.toLowerCase()||t===a.RepositoryTypes.TfsGit.toLowerCase()},this._handleQueueSelected=e=>{this._selectedQueue=e,this.fetchDemands(),this.emitChanged()},this._handleBranchUpdated=e=>{this._resetPipelineSources(),this._sourceBranch=e,this._resetPipelineResources(),this.emitChanged()},this._handleTagUpdated=e=>{this._resetPipelineSources(),this._sourceTag=e,this._resetPipelineResources(),this.emitChanged()},this._handleShelvesetUpdated=e=>{this._shelvesetName=e,this.emitChanged()},this._handleToggleEnableDiagnostic=e=>{this._enableDiagnostic=e,this.emitChanged()},this._handleVersionUpdated=e=>{this._sourceVersion=e,this._resetPipelineResources(),this.emitChanged()},this._resetPipelineSources=()=>{this._sourceBranch="",this._sourceTag="",this._sourceVersion=""},this._pageContext=e.pageContext,this._definitionId=e.definitionId,e.buildDefinition&&(this._buildDefinition=e.buildDefinition),this._sourceBranch=e.sourceBranch||"",this._projectId=e.projectId,this._sourceVersionActionHub=e.sourceVersionActionHub,this._shelvesetPickerActiobHub=e.shelvesetPickerActiobHub,this._buildRepository=e.buildRepository,this._queueActionHub=e.queueActionHub,this._definitionVariables=e.definitionVariables,this._runtimeVariables=new r.ObservableArray(this._createRuntimeVariablesArray(e.runtimeVariables)),this._enableDiagnosticActionHub=e.enableDiagnosticActionHub,this._sourceVersionActionHub.versionUpdated.addListener(this._handleVersionUpdated),this._sourceVersionActionHub.branchUpdated.addListener(this._handleBranchUpdated),this._sourceVersionActionHub.tagUpdated.addListener(this._handleTagUpdated),this._shelvesetPickerActiobHub.pickerDismissed.addListener(this._handleShelvesetUpdated),this._enableDiagnosticActionHub.toggleEnableDiagnostic.addListener(this._handleToggleEnableDiagnostic),this._queueActionHub.queueSelected.addListener(this._handleQueueSelected),this._demands=new r.ObservableArray([]),this._stageOptions=new r.ObservableArray([]),this._buildClient=this._pageContext.getRestClient("IBuildRestClient"),this._templateParameters=new r.ObservableArray([]),this._previousTemplateParameters=e.previousTemplateParameters,this._repositoryResources=new r.ObservableArray([]),(0,o.isFeatureFlagEnabled)(this._pageContext,"Build2.SetPipelineResources",!1)&&(this._pipelineResources=new r.ObservableArray([]),this._pipelineResourceRuns=new r.ObservableObject),(0,o.isFeatureFlagEnabled)(this._pageContext,"Build2.SetBuildResources",!1)&&(this._buildResources=new r.ObservableArray([]),this._buildResourceRuns=new r.ObservableObject),(0,o.isFeatureFlagEnabled)(this._pageContext,"Build2.SetContainerResources",!1)&&(this._containerResources=new r.ObservableArray([]),this._containerResourceRuns=new r.ObservableObject),(0,o.isFeatureFlagEnabled)(this._pageContext,"Build2.SetPackageResources",!1)&&(this._packageResources=new r.ObservableArray([]))}async fetchPipelineResources(){await this._fetchPipelineRunParameters()}async fetchPipelineStages(){return this._stageOptions.removeAll(),await this._fetchPipelineRunParameters(),this._stageOptions.value}async fetchOrgSettings(){return await this._fetchOrgSettings(),this._orgSettings}async fetchProjSettings(){return await this._fetchProjSettings(),this._projSettings}async fetchPipelineResourceRuns(e,t,s,i,a,r){await this._fetchPipelineResourceRuns(e,t,s,i,a,r)}async fetchBuildResourceRuns(e,t,s,i){await this._fetchBuildResourceRuns(e,t,s,i)}async fetchContainerResourceRuns(e,t,s,i){await this._fetchContainerResourceRuns(e,t,s,i)}async fetchPipelineTemplateParameters(){this._templateParametersAreValid.value=!1,await this._fetchPipelineRunParameters(!0)}getRunTimeVariables(){const e={};return this._runtimeVariables.value.forEach((t=>{t.name&&t.name.trim()&&(!t.isSecret||t.value)&&(e[t.name]={value:t.value,isSecret:t.isSecret})})),this._enableDiagnostic&&(e["system.debug"]={value:"true",isSecret:!1},e["agent.diagnostic"]={value:"true",isSecret:!1}),e}getSerializedVariables(){const e={};return this._runtimeVariables.value.forEach((t=>{t.name&&t.name.trim()&&(!t.isSecret||t.value)&&(e[t.name]=t.value)})),this._enableDiagnostic&&(e["system.debug"]="true",e["agent.diagnostic"]="true"),JSON.stringify(e)}getDemandsValues(){return this._convertDemandDataToSerializedDemand()}get demands(){return this._demands}get runtimeVariables(){return this._runtimeVariables}get buildResources(){return this._buildResources}get containerResources(){return this._containerResources}get packageResources(){return this._packageResources}get pipelineResources(){return this._pipelineResources}get repositoryResources(){return this._repositoryResources}get buildResourceRuns(){return this._buildResourceRuns}get containerResourceRuns(){return this._containerResourceRuns}get pipelineResourceRuns(){return this._pipelineResourceRuns}get templateParameters(){return this._templateParameters}get templateParametersAreValid(){return this._templateParametersAreValid}get runParametersAreLoaded(){return!!this._pipelineRunParameters&&this._runParametersAreLoaded}get templateParametersAreLoaded(){return!!this._pipelineRunParameters&&!!this._pipelineRunParameters.templateParameters}get stageOptions(){return this._stageOptions}get skippedStageNames(){return this._stageOptions.value.filter((e=>e.skip)).map((e=>e.refName))}get errorMessage(){return this._errorMessage}getSourceBranch(){if(this._buildRepository&&this._buildRepository.type&&this._isGit(this._buildRepository.type)){if(this._sourceBranch&&!this._sourceBranch.startsWith(z.GitConstants.RefsHeadsPrefix)&&!this._sourceBranch.startsWith(z.GitConstants.RefsPrefix))return z.GitConstants.RefsHeadsPrefix+this._sourceBranch;if(this._sourceTag)return this._sourceTag.startsWith(z.GitConstants.RefsTagsPrefix)?this._sourceTag:z.GitConstants.RefsTagsPrefix+this._sourceTag}return this._sourceBranch}getSourceVersion(){return this._sourceVersion}getShelvesetName(){return this._shelvesetName}getSelectedQueue(){return this._selectedQueue}getEnableDiagnosticState(){return this._enableDiagnostic}getShelvesetPickerActionHub(){return this._shelvesetPickerActiobHub}getSourceControlSelectorActionHub(){return this._sourceVersionActionHub}getEnableDiagnosticActionHub(){return this._enableDiagnosticActionHub}dispose(){this._sourceVersionActionHub.versionUpdated.removeListener(this._handleVersionUpdated),this._sourceVersionActionHub.branchUpdated.removeListener(this._handleBranchUpdated),this._sourceVersionActionHub.tagUpdated.removeListener(this._handleTagUpdated),this._shelvesetPickerActiobHub.pickerDismissed.removeListener(this._handleBranchUpdated),this._queueActionHub.queueSelected.removeListener(this._handleQueueSelected)}getModifiedRepositoryResources(){const e=this._pipelineRunParameters&&this._pipelineRunParameters.repositoryResources||[];return(this._repositoryResources&&this._repositoryResources.value||[]).filter((t=>{const s=e.find((e=>e.alias===t.alias));return!(s&&t.refName===s.refName&&t.version===s.version)}))}getModifiedBuildResources(){const e=this._pipelineRunParameters&&this._pipelineRunParameters.buildResources||[];return(this._buildResources&&this._buildResources.value||[]).filter((t=>{const s=e.find((e=>e.alias===t.alias));return!(s&&t.version===s.version)}))}getModifiedContainerResources(){const e=this._pipelineRunParameters&&this._pipelineRunParameters.containerResources||[];return(this._containerResources&&this._containerResources.value||[]).filter((t=>{const s=e.find((e=>e.alias===t.alias));return!(s&&t.version===s.version)}))}getModifiedPackageResources(){const e=this._pipelineRunParameters&&this._pipelineRunParameters.packageResources||[];return(this._packageResources&&this._packageResources.value||[]).filter((t=>{const s=e.find((e=>e.alias===t.alias));return!(s&&t.version===s.version)}))}getModifiedPipelineResources(){const e=this._pipelineRunParameters&&this._pipelineRunParameters.pipelineResources||[];return(this._pipelineResources&&this._pipelineResources.value||[]).filter((t=>{const s=e.find((e=>e.alias===t.alias));return!(s&&t.version===s.version)}))}getTemplateParametersDictionary(){const e=this.templateParameters&&this.templateParameters.value;let t;return e&&e.length>0&&(t={},e.forEach((e=>{t[e.data.name]=e.value||e.data.default}))),t}_resetPipelineResources(){this._errorMessage.value="",this._runParametersAreLoaded=!1,this._pipelineRunParameters=void 0,this._templateParameters.value=[],this._repositoryResources&&(this._repositoryResources.value=[]),this._pipelineResources&&(this._pipelineResources.value=[]),this._buildResources&&(this._buildResources.value=[]),this._containerResources&&(this._containerResources.value=[]),this._pipelineResourceRuns&&this._pipelineResourceRuns.keys().length&&(this._pipelineResourceRuns=new r.ObservableObject),this._buildResourceRuns&&this._buildResourceRuns.keys().length&&(this._buildResourceRuns=new r.ObservableObject),this._containerResourceRuns&&this._containerResourceRuns.keys().length&&(this._containerResourceRuns=new r.ObservableObject),this._packageResources&&(this._packageResources.value=[]),this._stageOptions.value=[]}_resetParameterDependentResources(){this._repositoryResources&&(this._repositoryResources.value=[]),this._pipelineResourceRuns&&this._pipelineResourceRuns.keys().length&&(this._pipelineResourceRuns=new r.ObservableObject),this._buildResourceRuns&&this._buildResourceRuns.keys().length&&(this._buildResourceRuns=new r.ObservableObject),this._containerResourceRuns&&this._containerResourceRuns.keys().length&&(this._containerResourceRuns=new r.ObservableObject),this._stageOptions.value=[],this._runParametersAreLoaded=!1}_convertDemandDataToSerializedDemand(){const e=[];return(this._demands.value||[]).forEach((t=>{switch(t.condition){case 0:e.push(t.name.trim());break;case 1:e.push((0,n.format)("{0} -equals {1}",t.name.trim(),t.value.trim()))}})),e}_convertSerializedDemandToDemandData(e){const t=[];return e&&e.length>0&&e.forEach(((e,s)=>{const i={index:s,name:"",condition:0,value:""},a=d._demandRegex.exec(e)||{};a&&(i.name=a[1]?a[1]:"",i.value=a[4]?a[4]:"",a[3]&&a[3].length>0&&"equals"===a[3].toLocaleLowerCase()?i.condition=1:i.condition=0),t.push(i)})),t}_fetchPipelineRunParameters(e=!1){return new Promise((t=>{if(this.runParametersAreLoaded&&!e)this._updateFromRunParameters(),t();else{const i={pipelineId:this._definitionId,sourceBranch:this.getSourceBranch(),sourceVersion:this.getSourceVersion(),onlyFetchTemplateParameters:e,templateParameters:this.getTemplateParametersDictionary()||{}},a=this._pageContext.getService("IVssContributionService");a.getDataAsync(s,i,!0).then((i=>{const r=a.getDataProviderExceptions()[s];if(i)this._pipelineRunParameters=i,e?this._updateTemplateParameters():(this._updateFromRunParameters(),this._runParametersAreLoaded=!0),this._setErrorMessage(e),t();else if(r&&"YamlFileNotFoundException"===r.exceptionType)this._errorMessage.value=H.YamlMissingError;else{const e=r&&r.message;console.log("Failed to retrieve pipeline resources and stages: "+e),t()}}))}}))}_fetchOrgSettings(){return new Promise((e=>{this._pageContext.getService("IVssContributionService").getDataAsync("ms.vss-build-web.pipelines-org-settings-queue-data-provider",void 0).then((t=>{this._orgSettings=t,e()}))}))}_fetchProjSettings(){return new Promise((e=>{this._pageContext.getService("IVssContributionService").getDataAsync("ms.vss-build-web.pipelines-general-settings-queue-data-provider",void 0).then((t=>{this._projSettings=t,e()}))}))}_updateFromRunParameters(){const e=this._pipelineRunParameters;if(e){if(e.stages&&this._stageOptions){const t={};e.stages.forEach((e=>t[e.refName.toLowerCase()]=e.name)),this._stageOptions.value=e.stages.map((e=>({name:e.name,refName:e.refName,dependsOn:(e.dependsOn||[]).map((e=>t[e.toLowerCase()])),skip:!1})))}e.buildResources&&this._buildResources&&(this._buildResources.value=e.buildResources.map((e=>Object.assign({},e))).sort(((e,t)=>(0,n.localeIgnoreCaseComparer)(e.name,t.name)))),e.containerResources&&this._containerResources&&(this._containerResources.value=e.containerResources.map((e=>Object.assign({},e))).sort(((e,t)=>(0,n.localeIgnoreCaseComparer)(e.name,t.name)))),e.packageResources&&this._packageResources&&(this._packageResources.value=e.packageResources.map((e=>Object.assign({},e))).sort(((e,t)=>(0,n.localeIgnoreCaseComparer)(e.name,t.name)))),e.pipelineResources&&this._pipelineResources&&(this._pipelineResources.value=e.pipelineResources.map((e=>Object.assign({},e))).sort(((e,t)=>(0,n.localeIgnoreCaseComparer)(e.name,t.name)))),e.repositoryResources&&this._repositoryResources&&(this._repositoryResources.value=e.repositoryResources.map((e=>Object.assign({},e))).sort(((e,t)=>(0,n.localeIgnoreCaseComparer)(e.name,t.name))))}}_updateTemplateParameters(){const e=this._pipelineRunParameters&&this._pipelineRunParameters.templateParameters;e&&(this._templateParameters.value=e.map((e=>{const t=this._previousTemplateParameters[e.name]||e.default||e.values&&e.values.length>0&&e.values[0]||3===e.type&&"false"||"";return{data:Object.assign({},e),value:t,errorMessage:this._validateTemplateParameterInput(e,t)}})),this._updateTemplateParametersValidity())}_setErrorMessage(e){const t=this._pipelineRunParameters&&this._pipelineRunParameters.errors;t&&0!==t.length&&(this._errorMessage.value=(0,n.format)(H.YamlParseError,t.join("\n")),e&&(this._templateParametersAreValid.value=!1))}_validateTemplateParameterInput(e,t){if(!e||3===e.type||5===e.type||4===e.type)return;const s=t.trim();return s||e.default?2===e.type&&isNaN(Number(s))?H.NumericInputErrorMessage:void 0:""}_updateTemplateParametersValidity(){const e=this._templateParameters.value;if(e){let t=!0;for(let s=0;s<e.length;s++){if(void 0!==e[s].errorMessage){t=!1;break}}this._templateParametersAreValid.value!==t&&(this._templateParametersAreValid.value=t)}}_fetchPipelineResourceRuns(e,t,s,i,a,n){return new Promise((o=>{const c={keywordFilter:i,project:e,source:s,branch:a,tags:n},u=this._pageContext.getService("IVssContributionService");u.getDataAsync(l,c,!0).then((e=>{if(e)this._pipelineResourceRuns=new r.ObservableObject,this._pipelineResourceRuns.add(t,e),o();else{const e=u.getDataProviderExceptions()[l],t=e&&e.message;console.log("Failed to retrieve pipeline runs for the resource: "+t),o()}}))}))}_fetchBuildResourceRuns(e,t,s,i){return new Promise((a=>{const n={connectionId:t,source:i,buildType:s},o=this._pageContext.getService("IVssContributionService");o.getDataAsync(c,n,!0).then((t=>{if(t)this._buildResourceRuns||(this._buildResourceRuns=new r.ObservableObject),this._buildResourceRuns.add(e,t),a();else{const e=o.getDataProviderExceptions()[c],t=e&&e.message;console.log("Failed to retrieve build runs for the resource: "+t),a()}}))}))}_fetchContainerResourceRuns(e,t,s,i){return new Promise((a=>{const n={connectionId:t,properties:i,containerType:s},o=this._pageContext.getService("IVssContributionService");o.getDataAsync("ms.vss-build-web.container-resource-runs-data-provider",n,!0).then((t=>{if(t)this._containerResourceRuns||(this._containerResourceRuns=new r.ObservableObject),this._containerResourceRuns.add(e,t),a();else{const e=o.getDataProviderExceptions()[c],t=e&&e.message;console.log("Failed to retrieve container images for the resource: "+t),a()}}))}))}}t.StoresQueueBuild.QueueBuildStore=d,d._demandRegex=/^([^\s]+)(\s+\-([^\s]+)\s+(.*))?/,d.key="build-commands-queue-build-store"}(),function(e){G=t.BuildResourcePanel={};class s extends l.Component{constructor(e){super(e),this._selection=new u.ListSelection({selectOnFocus:!1,multiSelect:!1}),this._renderRunCell=(e,t,s,i)=>{const a=l.createElement(R.Tooltip,{text:i.runId,overflowOnly:!0},l.createElement("span",{className:"text-ellipsis primary-text"},"#",i.runId));return l.createElement(b.TwoLineTableCell,{columnIndex:t,tableColumn:s,key:"col-"+t,iconProps:{render:()=>l.createElement(_.Status,Object.assign({},this._getStatusPropsForBuildResult(),{key:"result",size:"24",className:"flex-self-center margin-right-8"}))},line1:a,line2:l.createElement("span",null)})},this._update=()=>{const e=Object.assign({},this.state);e.version=this._selectedRun,this.props.onUpdate(e),this.props.onDismiss()},this._onChangeSearchText=(e,t)=>{this._searchBuildRuns(t)},this._onClickClearButton=e=>{this._filteredRuns.value=this._runs.value,this._updateSelection(this._filteredRuns.value),this.setState({searchText:""})},this._searchBuildRuns=e=>{const t=e.toLowerCase(),s=this._runs.value.filter((e=>e.runId.toLowerCase().indexOf(t)>-1));this._filteredRuns.value=s,this._updateSelection(s),this.setState({searchText:e})},this._updateSelection=e=>{let t=!1;this.state.version?(e.some(((e,s)=>{if((0,n.equals)(e.runId,this.state.version))return this._selection.select(s),t=!0,!0})),t||this._selection.clear()):this.state.searchText||e.length>0&&(this._selection.select(0),this.setState({version:e[0].runId}))},this._updateResourceRuns=()=>{const e=[];if(this.props.store.buildResourceRuns){const t=this.props.store.buildResourceRuns.get(this.state.alias);t&&t.length>0&&e.push(...t)}this._runs.value=e,this.state.searchText?this._searchBuildRuns(this.state.searchText):(this._filteredRuns.value=e,this._updateSelection(e))},this._getStatusPropsForBuildResult=()=>_.Statuses.Success,this._tableColumns=[new b.ColumnSelect,{id:"pipeline-run",width:404,name:"Pipeline run",renderCell:this._renderRunCell}],this._isLoading=new r.ObservableValue(!1),this._runs=new r.ObservableArray([]),this._filteredRuns=new r.ObservableArray([]);const t=Object.assign(Object.assign({},e.resource),{searchText:""});this.state=t}componentDidMount(){this._initializeResourceVersions()}render(){return l.createElement(p.Panel,{backButtonProps:{onClick:this.props.onDismiss},contentClassName:"queue-panel-child no-padding",description:H.PipelineResourcePanelDescription,escDismiss:!0,onDismiss:this.props.onDismiss,titleProps:{text:this.props.resource.name},className:"pipeline-resource-panel",footerButtonProps:[{text:H.CancelButtonText,onClick:this.props.onDismiss},{text:H.PipelineResourceUpdateButtonText,primary:!0,onClick:this._update}]},l.createElement("div",{className:"margin-vertical-8 flex-grow"},this._getSearchBar(),this._buildVersionsTableComponent()))}componentWillUnmount(){this.props.store.buildResourceRuns&&this.props.store.buildResourceRuns.unsubscribe(this._updateResourceRuns)}async _initializeResourceVersions(){this.props.store.getBuildResourceRuns(this.state.alias)||(this._isLoading.value=!0,await this.props.store.fetchBuildResourceRuns(this.state.alias,this.state.connectionId,this.state.buildType,this.state.name),this._isLoading.value=!1),this._updateResourceRuns(),this.props.store.buildResourceRuns&&this.props.store.buildResourceRuns.subscribe(this._updateResourceRuns)}_buildVersionsTableComponent(){return l.createElement("div",{className:"flex flex-grow flex-column"},l.createElement(d.Observer,{loading:this._isLoading,versions:this._filteredRuns},(e=>e.loading?l.createElement("div",null,l.createElement(g.Spinner,{className:"queue-build-spinner"})):l.createElement(d.Observer,{versions:this._filteredRuns},(e=>{if(e.versions.length>0)return l.createElement(b.Table,{selection:this._selection,onSelect:(e,t)=>{this._selectedRun=t.data.runId},columns:this._tableColumns,itemProvider:this._getItemProvider(e.versions)});{const e=this.state.searchText?(0,n.format)(H.PipelineResourceNoSearchResultsText,this.state.searchText):H.BuildResourceNoRunsText;return l.createElement("div",{className:"margin-vertical-8 padding-horizontal-20"},l.createElement(h.MessageCard,{severity:"Info"},e))}})))))}_getSearchBar(){return l.createElement(v.TextField,{placeholder:H.PipelineResourceSearchBarText,className:"margin-horizontal-20 margin-bottom-8",onChange:this._onChangeSearchText,prefixIconProps:{iconName:"Search"},suffixIconProps:this.state.searchText?{render:e=>l.createElement(c.Button,{ariaLabel:m.ClearFilter,className:(0,S.css)(e,"bolt-text-filterbaritem-clear"),iconProps:{iconName:"Cancel"},onClick:this._onClickClearButton})}:void 0,value:this.state.searchText})}_getItemProvider(e){const t=e.map((e=>e));return new f.ArrayItemProvider(t)}}t.BuildResourcePanel.BuildResourcePanel=s}(),function(e){Y=t[e]={};class s extends l.Component{constructor(e){super(e),this._selection=new u.ListSelection({selectOnFocus:!1,multiSelect:!1}),this._renderRunCell=(e,t,s,i)=>{const a=l.createElement(R.Tooltip,{text:i.imageId,overflowOnly:!0},l.createElement("span",{className:"text-ellipsis primary-text"},"#",i.imageId));return l.createElement(b.TwoLineTableCell,{columnIndex:t,tableColumn:s,key:"col-"+t,iconProps:{render:()=>l.createElement(_.Status,Object.assign({},this._getStatusPropsForBuildResult(),{key:"result",size:"24",className:"flex-self-center margin-right-8"}))},line1:a,line2:l.createElement("span",null)})},this._update=()=>{const e=Object.assign({},this.state);e.version=this._selectedRun,this.props.onUpdate(e),this.props.onDismiss()},this._onChangeSearchText=(e,t)=>{this._searchContainerRuns(t)},this._onClickClearButton=e=>{this._filteredRuns.value=this._runs.value,this._updateSelection(this._filteredRuns.value),this.setState({searchText:""})},this._searchContainerRuns=e=>{const t=e.toLowerCase(),s=this._runs.value.filter((e=>e.imageId.toLowerCase().indexOf(t)>-1));this._filteredRuns.value=s,this._updateSelection(s),this.setState({searchText:e})},this._updateSelection=e=>{let t=!1;this.state.version?(e.some(((e,s)=>{if((0,n.equals)(e.imageId,this.state.version))return this._selection.select(s),this.setState({useSelectedImageDisabled:!1}),t=!0,!0})),t||this._selection.clear()):this.state.searchText||e.length>0&&(this._selection.select(0),this._selectedRun=e[0].imageId,this.setState({version:e[0].imageId,useSelectedImageDisabled:!1}))},this._updateResourceRuns=()=>{const e=[];if(this.props.store.containerResourceRuns){const t=this.props.store.containerResourceRuns.get(this.state.alias);t&&t.length>0&&e.push(...t)}this._runs.value=e,this.state.searchText?this._searchContainerRuns(this.state.searchText):(this._filteredRuns.value=e,this._updateSelection(e))},this._getStatusPropsForBuildResult=()=>_.Statuses.Success,this._tableColumns=[new b.ColumnSelect,{id:"pipeline-run",width:404,name:"Pipeline run",renderCell:this._renderRunCell}],this._isLoading=new r.ObservableValue(!1),this._runs=new r.ObservableArray([]),this._filteredRuns=new r.ObservableArray([]);const t=Object.assign(Object.assign({},e.resource),{searchText:"",useSelectedImageDisabled:!1});this.state=t}componentDidMount(){this._initializeResourceVersions()}render(){return l.createElement(p.Panel,{backButtonProps:{onClick:this.props.onDismiss},contentClassName:"queue-panel-child no-padding",description:H.PipelineResourcePanelDescription,escDismiss:!0,onDismiss:this.props.onDismiss,titleProps:{text:this.props.resource.name},className:"pipeline-resource-panel",footerButtonProps:[{text:H.CancelButtonText,onClick:this.props.onDismiss},{disabled:this.state.useSelectedImageDisabled,text:H.ContainerResourceUpdateButtonText,primary:!0,onClick:this._update}]},l.createElement("div",{className:"margin-vertical-8 flex-grow"},this._getSearchBar(),this._buildVersionsTableComponent()))}componentWillUnmount(){this.props.store.containerResourceRuns&&this.props.store.containerResourceRuns.unsubscribe(this._updateResourceRuns)}async _initializeResourceVersions(){this.props.store.getContainerResourceRuns(this.state.alias)||(this._isLoading.value=!0,await this.props.store.fetchContainerResourceRuns(this.state.alias,this.state.connectionId,this.state.containerType,this.state.properties),this._isLoading.value=!1),this._updateResourceRuns(),this.props.store.containerResourceRuns&&this.props.store.containerResourceRuns.subscribe(this._updateResourceRuns)}_buildVersionsTableComponent(){return l.createElement("div",{className:"flex flex-grow flex-column"},l.createElement(d.Observer,{loading:this._isLoading,versions:this._filteredRuns},(e=>e.loading?l.createElement("div",null,l.createElement(g.Spinner,{className:"queue-build-spinner"})):l.createElement(d.Observer,{versions:this._filteredRuns},(e=>{if(e.versions.length>0)return l.createElement(b.Table,{selection:this._selection,onSelect:(e,t)=>{let s=!1;0==this._selection.selectedCount&&(s=!0),this.setState({useSelectedImageDisabled:s}),this._selectedRun=t.data.imageId},columns:this._tableColumns,itemProvider:this._getItemProvider(e.versions)});{const e=this.state.searchText?(0,n.format)(H.PipelineResourceNoSearchResultsText,this.state.searchText):H.ContainerResourceNoRunsText;return l.createElement("div",{className:"margin-vertical-8 padding-horizontal-20"},l.createElement(h.MessageCard,{severity:"Info"},e))}})))))}_getSearchBar(){return l.createElement(v.TextField,{placeholder:H.PipelineResourceSearchBarText,className:"margin-horizontal-20 margin-bottom-8",onChange:this._onChangeSearchText,prefixIconProps:{iconName:"Search"},suffixIconProps:this.state.searchText?{render:e=>l.createElement(c.Button,{ariaLabel:m.ClearFilter,className:(0,S.css)(e,"bolt-text-filterbaritem-clear"),iconProps:{iconName:"Cancel"},onClick:this._onClickClearButton})}:void 0,value:this.state.searchText})}_getItemProvider(e){const t=e.map((e=>e));return new f.ArrayItemProvider(t)}}t[e].ContainerResourcePanel=s}("ContainerResourcePanel"),function(e){K=t.FormInputLabel={};t.FormInputLabel.FormInputLabel=e=>{const{primaryLabel:t,secondaryLabel:s}=e;return l.createElement("div",{className:"flex-row variable-label-div"},l.createElement("div",{className:"variable-label-primary-text"},t),l.createElement("div",{className:"variable-label-secondary-text secondary-text"},s))}}(),function(e){$=t.DemandPanel={};class s extends l.Component{constructor(e){super(e),this._onKeyDown=e=>{const t=!this._isValidName()||!this._isValidValue();"Enter"!==e.key||e.defaultPrevented||t||(this._clickOk(),e.preventDefault())},this._onNameChanged=(e,t)=>{this.state.demand.name=t,this.setState({demand:this.state.demand})},this._onValueChanged=(e,t)=>{this.state.demand.value=t,this.setState({demand:this.state.demand})},this._onConditionChanged=e=>{this.state.demand.condition=e,this.setState({demand:this.state.demand})},this._isValidName=()=>{const e=this.state.demand;return!(!e.name||""===e.name.trim())},this._isValidValue=()=>{const e=this.state.demand;return!!(1!==e.condition||e.value&&""!==e.value.trim())},this._clickOk=()=>{this.props.isNewDemand&&this.props.onDemandAdded?this.props.onDemandAdded(this.state.demand):!this.props.isNewDemand&&this.props.onDemandUpdated&&this.props.onDemandUpdated(this.state.demand),this.props.onDismiss()},this.state={demand:this.props.demand}}render(){const e=this.props.isNewDemand?H.AddDemandPanelTitle:H.UpdateDemandPanelTitle,t=this.props.isNewDemand?H.CreateButtonText:H.UpdateButtonText,s=!this._isValidName()||!this._isValidValue(),a=this.props.isNewDemand?".variable-panel-demand-name":".variable-panel-demand-condition";return l.createElement(p.Panel,{backButtonProps:{subtle:!0,iconProps:{iconName:"Back"},onClick:this.props.onDismiss,ariaLabel:H.Back},onDismiss:this.props.onDismiss,titleProps:{text:e},className:"variable-panel",defaultActiveElement:a,footerButtonProps:[{text:H.CancelButtonText,onClick:this.props.onDismiss},{text:t,primary:!0,onClick:this._clickOk,disabled:s}]},l.createElement(i,{demand:this.state.demand,isNewDemand:this.props.isNewDemand,onNameChanged:this._onNameChanged,onConditionChanged:this._onConditionChanged,onValueChanged:this._onValueChanged,onKeyDown:this._onKeyDown}))}}t.DemandPanel.DemandPanel=s;class i extends l.Component{constructor(){super(...arguments),this._getDemandNameControl=()=>l.createElement(C.FormItem,{className:"variable-panel-demand-name flex-grow margin-bottom-16",label:l.createElement(K.FormInputLabel,{primaryLabel:H.NameFieldLabel,secondaryLabel:H.RequiredLabel})},l.createElement(v.TextField,{ariaLabel:H.NameFieldLabel,value:this.props.demand.name,className:"primary-text",ref:e=>{this._nameTextFieldRef=e},onChange:this.props.onNameChanged,disabled:!this.props.isNewDemand,required:!0})),this._getDemandConditionControl=()=>l.createElement("div",{className:"variable-condition-container flex-grow margin-bottom-16"},l.createElement("label",{className:"flex-grow flex-row margin-bottom-8"},H.ConditionFieldLabel),l.createElement(P.PickListDropdown,{selectOnFocus:!0,ariaLabelFormat:H.ConditionFieldLabel,selectedItems:this._getSelectedCondition(),className:"variable-panel-demand-condition flex-grow primary-text",ref:e=>{this._conditionDropDownRef=e},getPickListItems:this._getConditions,getListItem:e=>({key:e&&e.key?e.key.toString():"",name:e?e.name:""}),onSelectionChanged:e=>this.props.onConditionChanged(e.selectedItems[0].key)})),this._getDemandValueControl=()=>l.createElement(C.FormItem,{className:"flex-grow margin-bottom-16",label:l.createElement(K.FormInputLabel,{primaryLabel:H.ValueFieldLabel,secondaryLabel:H.RequiredLabel})},l.createElement(v.TextField,{value:this.props.demand.value,className:"primary-text",onChange:this.props.onValueChanged,required:!0})),this._getSelectedCondition=()=>1===this.props.demand.condition?[{key:this.props.demand.condition,name:H.EqualsCondition}]:[{key:this.props.demand.condition,name:H.ExistsCondition}],this._getConditions=()=>[{key:1,name:H.EqualsCondition},{key:0,name:H.ExistsCondition}]}render(){return l.createElement("div",{className:"variable-panel-content flex-grow",onKeyDown:this.props.onKeyDown},this._getDemandNameControl(),this._getDemandConditionControl(),1===this.props.demand.condition&&this._getDemandValueControl())}componentDidMount(){this.props.isNewDemand?(this._nameTextFieldRef&&this._nameTextFieldRef.focus(),this._nameTextFieldRef&&this._nameTextFieldRef.select()):this._conditionDropDownRef&&this._conditionDropDownRef.focus()}}}(),function(e){J=t[e]={};class s extends l.Component{constructor(e){super(e),this._listSelection=new u.ListSelection,this._onKeyDown=e=>{if("delete"===e.key.toLowerCase()&&this._listSelection.selectedCount>0){const t=this._listSelection.value[0].beginIndex;this.props.store.deleteDemand(t),e.preventDefault()}},this._renderRow=(e,t,s)=>{const i=t.name?(0,n.format)(H.DeleteButtonTooltip,t.name):H.DeleteButtonEmptyTooltip,a=1===t.condition?"= "+t.value:H.ExistsCondition,r=(0,S.getSafeId)(this.c_hiddenAriaDivId);return l.createElement(u.ListItem,{key:"list-item"+e,index:e,details:s},l.createElement("div",{className:"queue-panel-list-row flex-grow flex-row"},l.createElement("div",{className:"flex-column justify-center","aria-describedby":r},l.createElement("span",{className:"text-ellipsis primary-text","aria-label":t.name},t.name),l.createElement("span",{className:"font-size text-ellipsis secondary-text","aria-label":a},a),l.createElement("div",{"aria-label":H.ListItemRoleDescription,id:r})),l.createElement("span",{className:"flex-grow flex-row justify-end"},l.createElement("div",{className:"flex-column justify-center margin-right-16"},l.createElement(c.Button,{ariaLabel:i,className:"bolt-list-cell-content-reveal",iconProps:{iconName:"Delete"},onClick:t=>{this.props.store.deleteDemand(e),t.preventDefault()},subtle:!0,tooltipProps:{text:i}})),l.createElement(x.Icon,{iconName:"ChevronRightMed",size:"medium"}))))},this._createDemand=()=>{const e={index:this.props.store.demands.length,condition:0};this._renderDemandPanel(e,!0)},this._updateDemand=(e,t)=>{this._renderDemandPanel(Object.assign({},t.data),!1)},this._renderDemandPanel=(e,t)=>{this.props.pageContext.getService("IVssLayoutManager").renderCallout((s=>l.createElement($.DemandPanel,{demand:e,isNewDemand:t,onDismiss:s,onDemandAdded:e=>this.props.store.addDemand(e),onDemandUpdated:e=>this.props.store.updateDemand(e)})))},this.c_hiddenAriaDivId="hiddenAriaDiv",this._itemProvider=this.props.store.demands}render(){return l.createElement(p.Panel,{backButtonProps:{onClick:this.props.onDismiss},contentClassName:"queue-panel-child no-padding",description:this.props.pipelineName,escDismiss:!0,footerButtonProps:[{text:H.AddDemandButton,primary:!0,onClick:this._createDemand}],onDismiss:this.props.onDismiss,titleProps:{text:H.DemandsTitle}},l.createElement("div",{className:"queue-panel-list-container"},l.createElement("div",{className:"flex-row scroll-auto",onKeyDown:this._onKeyDown},l.createElement(u.ScrollableList,{ariaLabel:H.DemandsTitle,itemProvider:this._itemProvider,renderRow:this._renderRow,width:"100%",singleClickActivation:!0,selection:this._listSelection,onActivate:this._updateDemand,outerClassName:"custom-scrollbar"})),l.createElement(d.Observer,{demands:this._itemProvider},(e=>0===e.demands.length?l.createElement("span",{className:"flex-row margin-vertical-8 padding-horizontal-20 primary-text"},l.createElement("label",{className:"margin-right-4"},H.EmptyDemandsDescription),l.createElement(y.Link,{href:"https://go.microsoft.com/fwlink/?linkid=2087182",ariaLabel:H.DemandsLearnMore},H.LearnMoreMessage)):null))))}}t[e].DemandsControllerView=s}("DemandsControllerView"),function(e){X=t[e]={};class s extends l.Component{constructor(e){super(e),this._update=()=>{const e=Object.assign({},this.state);this.props.onUpdate(e),this.props.onDismiss()};const t=Object.assign(Object.assign({},e.resource),{searchText:""});this.state=t}render(){return l.createElement(p.Panel,{backButtonProps:{onClick:this.props.onDismiss},contentClassName:"queue-panel-child no-padding",description:H.PipelineResourcePanelDescription,escDismiss:!0,onDismiss:this.props.onDismiss,titleProps:{text:this.props.resource.name},className:"pipeline-resource-panel",footerButtonProps:[{text:H.CancelButtonText,onClick:this.props.onDismiss},{text:H.PipelineResourceUpdateButtonText,primary:!0,onClick:this._update}]},l.createElement("div",{className:"margin-vertical-8 flex-grow"},this._getTextField()))}_getTextField(){return l.createElement(v.TextField,{placeholder:H.PackageResourceSearchBarText,className:"margin-horizontal-20 margin-bottom-8",value:this.state.version,onChange:(e,t)=>this.setState({version:t})})}}t[e].PackageResourcePanel=s}("PackageResourcePanel"),function(e){Z=t[e]={};const s="refs/tags/";class i extends l.Component{constructor(e){super(e),this._selection=new u.ListSelection({selectOnFocus:!1,multiSelect:!1}),this._renderRunCell=(e,t,i,a)=>{var r;const n=l.createElement(R.Tooltip,{text:a.runId,overflowOnly:!0},l.createElement("span",{className:"text-ellipsis primary-text"},"#",a.runId));let o,c="OpenSource";a.sourceBranch.startsWith(s)?(c="Tag",o=a.sourceBranch.replace(s,"")):o=a.sourceBranch.replace("refs/heads/","");const u=l.createElement("span",{className:"fontSize secondary-text flex-row flex-baseline text-ellipsis"},l.createElement(x.Icon,{className:"margin-right-4",iconName:c}),l.createElement(R.Tooltip,{text:a.sourceBranch,overflowOnly:!0},l.createElement("span",{className:"source-branch-content font-size text-ellipsis secondary-text"},o)),l.createElement(x.Icon,{className:"margin-left-4",iconName:"BranchCommit"}),l.createElement("span",null,null===(r=a.sourceVersion)||void 0===r?void 0:r.substring(0,8)));return l.createElement(b.TwoLineTableCell,{columnIndex:t,tableColumn:i,key:"col-"+t,iconProps:{render:()=>l.createElement(_.Status,Object.assign({},this._getStatusPropsForBuildResult(a.result),{key:a.result,size:"24",className:"flex-self-center margin-right-8"}))},line1:n,line2:u})},this._renderFinishTimeCell=(e,t,s,i)=>l.createElement(b.SimpleTableCell,{columnIndex:t,tableColumn:s,key:"col-"+t},l.createElement("span",{className:"flex-row flex-center font-size-m secondary-text"},i.finishTime&&l.createElement(D.Ago,{date:i.finishTime,format:0}))),this._update=()=>{const e=Object.assign({},this.state);e.version=this._selectedRun,this.props.onUpdate(e),this.props.onDismiss()},this._onChangeSearchText=(e,t)=>{this.setState({searchText:t,version:""}),this._searchPipelineRuns(t)},this._onClickClearButton=e=>{this.setState({searchText:"",version:""}),this._fetchPipelineResourceRuns("")},this._searchPipelineRuns=e=>{this._fetchPipelineResourceRuns(e)},this._updateSelection=e=>{let t=!1;var s;(this.state.version&&""!=this.state.version&&e.some(((e,s)=>{if((0,n.equals)(e.runId,this.state.version))return this._selection.select(s),this.setState({useSelecteRunDisabled:!1}),t=!0,!0})),t)||(this._selection.clear(),e.length>0&&(-1!=(s=(0,o.isFeatureFlagEnabled)(this.props.pageContext,"Build2.ResolveDefaultResourceVersion",!1)?e.findIndex((e=>e.isDefaultSelection)):0)?(this._selection.select(s),this._selectedRun=e[s].runId,this.setState({version:e[s].runId,useSelecteRunDisabled:!1})):this.setState({useSelecteRunDisabled:!0})))},this._updateResourceRuns=()=>{const e=[];if(this.props.store.pipelineResourceRuns){const t=this.props.store.pipelineResourceRuns.get(this.state.alias);t&&t.length>=0&&e.push(...t)}this._runs.value=e,this._filteredRuns.value=e,this._updateSelection(e)},this._getStatusPropsForBuildResult=e=>{switch(e){case"Succeeded":return _.Statuses.Success;case"PartiallySucceeded":return _.Statuses.Warning;case"Failed":return _.Statuses.Failed;case"Canceled":return _.Statuses.Canceled;default:return _.Statuses.Queued}},this._tableColumns=[new b.ColumnSelect,{id:"pipeline-run",width:300,name:H.PipelineRunColumnHeadingForPipelineResourcePanel,renderCell:this._renderRunCell},{id:"completed",width:104,name:H.CompletedColumnHeadingForPipelineResourcePanel,renderCell:this._renderFinishTimeCell}],this._selectedRun=e.resource.version,this._isLoading=new r.ObservableValue(!1),this._runs=new r.ObservableArray([]),this._filteredRuns=new r.ObservableArray([]);const t=Object.assign(Object.assign({},e.resource),{searchText:"",useSelecteRunDisabled:!1});this.state=t,this._timerManagement=new E.TimerManagement,this._searchPipelineRuns=this._timerManagement.debounce(this._searchPipelineRuns,500)}componentDidMount(){this._initializeResourceVersions()}render(){return l.createElement(p.Panel,{backButtonProps:{onClick:this.props.onDismiss},contentClassName:"queue-panel-child no-padding",description:H.PipelineResourcePanelDescription,escDismiss:!0,onDismiss:this.props.onDismiss,titleProps:{text:this.props.resource.name},className:"pipeline-resource-panel",footerButtonProps:[{text:H.CancelButtonText,onClick:this.props.onDismiss},{text:H.PipelineResourceUpdateButtonText,disabled:this.state.useSelecteRunDisabled,primary:!0,onClick:this._update}]},l.createElement("div",{className:"margin-vertical-8 flex-grow"},this._getSearchBar(),this._pipelineVersionsTableComponent()))}componentWillUnmount(){this.props.store.pipelineResourceRuns&&this.props.store.pipelineResourceRuns.unsubscribe(this._updateResourceRuns)}async _initializeResourceVersions(){this._fetchPipelineResourceRuns("")}async _fetchPipelineResourceRuns(e){this._isLoading.value=!0,await this.props.store.fetchPipelineResourceRuns(this.state.project,this.state.alias,this.state.name,e,this.state.branch,this.state.tags),this._isLoading.value=!1,this._updateResourceRuns(),this.props.store.pipelineResourceRuns&&this.props.store.pipelineResourceRuns.subscribe(this._updateResourceRuns)}_pipelineVersionsTableComponent(){return l.createElement("div",{className:"flex flex-grow flex-column"},l.createElement(d.Observer,{loading:this._isLoading,versions:this._filteredRuns},(e=>e.loading?l.createElement("div",null,l.createElement(g.Spinner,{className:"queue-build-spinner"})):l.createElement(d.Observer,{versions:this._filteredRuns},(e=>{if(e.versions.length>0)return l.createElement(b.Table,{selection:this._selection,onSelect:(e,t)=>{let s=!1;0==this._selection.selectedCount&&(s=!0),this.setState({useSelecteRunDisabled:s}),this._selectedRun=t.data.runId},columns:this._tableColumns,itemProvider:this._getItemProvider(e.versions)});{const e=this.state.searchText?(0,n.format)(H.PipelineResourceNoSearchResultsText,this.state.searchText):H.PipelineResourceNoRunsText;return l.createElement("div",{className:"margin-vertical-8 padding-horizontal-20"},l.createElement(h.MessageCard,{severity:"Info"},e))}})))))}_getSearchBar(){return l.createElement(v.TextField,{placeholder:H.PipelineResourceSearchBarText,className:"margin-horizontal-20 margin-bottom-8",onChange:this._onChangeSearchText,prefixIconProps:{iconName:"Search"},suffixIconProps:this.state.searchText?{render:e=>l.createElement(c.Button,{ariaLabel:m.ClearFilter,className:(0,S.css)(e,"bolt-text-filterbaritem-clear"),iconProps:{iconName:"Cancel"},onClick:this._onClickClearButton})}:void 0,value:this.state.searchText})}_getItemProvider(e){const t=e.map((e=>e));return new f.ArrayItemProvider(t)}}t[e].PipelineResourcePanel=i}("PipelineResourcePanel"),function(e){ee=t[e]={};const s="refs/heads/",i="refs/tags/";class r extends l.Component{constructor(e){super(e),this._branchSelected=e=>{const t=e.startsWith(s)?e:s+e;this.setState({refName:t,version:""})},this._branchSelectedForCommit=e=>{const t=e.startsWith(s)?e:s+e;this.setState({refName:t})},this._tagSelected=e=>{const t=e.startsWith(i)?e:i+e;this.setState({refName:t,version:""})},this._versionSelected=e=>{this.setState({version:e})},this._onFetchRepoError=e=>{this.setState({errorMessage:e})},this._update=()=>{const e=Object.assign({},this.state);this.props.onUpdate(e),this.props.onDismiss()};const t=Object.assign({},e.resource);this._initializeState(t),this.state=t}render(){const e=(0,n.format)(H.RepositoryResourcePanelDescription,this.sourceProvider.getName());return l.createElement(p.Panel,{backButtonProps:{onClick:this.props.onDismiss},contentClassName:"queue-panel-child no-padding",description:e,escDismiss:!0,onDismiss:this.props.onDismiss,titleProps:{text:this.props.resource.name},footerButtonProps:[{text:H.CancelButtonText,onClick:this.props.onDismiss},{text:H.RepositoryResourceUpdateButtonText,primary:!0,disabled:!this._isDirty(),onClick:this._update}]},l.createElement("div",{className:"flex-column flex-grow padding-horizontal-20 rhythm-vertical-8"},this.state.errorMessage&&l.createElement(h.MessageCard,{severity:"Error"},this.state.errorMessage),this._getBranchControl()))}_initializeState(e){if(this._isTfsGit()&&!e.projectName&&!e.projectId){const t=this.props.resource.name.split("/");if(2===t.length)e.projectName=t[0],e.name=t[1];else{const t=this.props.pageContext.getService("ITfsPageService").getData();t&&t.project&&(e.projectName=t.project.name,e.projectId=t.project.id)}}}_isTfsGit(){return(0,n.equals)(this.props.resource.type,a.RepositoryTypes.TfsGit,!0)}_getBranchControl(){const e=this.state,t=this._isTfsGit()?H.TfsGitSourceSelectorDescription:H.GitSourceSelectorDescription;return l.createElement(V.BranchDropdown,{className:"flex-column label margin-bottom-16 flex-grow",ariaLabel:H.RepositoryResourceSourceLabel,label:H.RepositoryResourceSourceLabel,autoFocus:!0,repositoryType:e.type,repositoryId:this.state.name,projectId:e.projectId||e.projectName,defaultBranch:this._getFriendlyRefName(this.props.resource.refName),description:t,connectionId:e.connectionId,currentCommit:e.version,onBranchSelected:this._branchSelected,onBranchSelectedForCommit:this._branchSelectedForCommit,onError:this._onFetchRepoError,onVersionSelected:this._versionSelected,onTagSelected:this._tagSelected,viewCommits:!0,viewTags:!0,pageContext:this.props.pageContext,isDrodownFullWidth:!0,showBranchPickerOnCommitSelected:!0})}_getFriendlyRefName(e){return(e=e||"").startsWith(s)?e.substr(s.length):e.startsWith(i)?e.substr(i.length):e}_isDirty(){return this.state.refName!==this.props.resource.refName||this.state.version!==this.props.resource.version}get sourceProvider(){return this.props.pageContext.getService("ISourceProviderService").getSourceProvider(this.state.type)}}t[e].RepositoryResourcePanel=r}("RepositoryResourcePanel"),function(e){function s(e){return void 0!==e.refName}te=t[e]={};class i extends l.Component{constructor(e){super(e),this._listSelection=new u.ListSelection,this._renderRow=(e,t,i)=>{let a,r,o,c;if(s(t)){a=t.alias.indexOf("://")>-1?t.name:(0,n.format)("{0} [{1}]",t.name,t.alias),o=this._getSourceProvider(t).getRepoIconName(),[r,c]=this._getUpdatedRefTextAndIcon(t.version||t.refName)}else a=(0,n.format)("{0} [{1}]",t.name,t.alias),o="Package",r=t.version||H.PipelineResourceLastRun,c=void 0;return l.createElement(u.ListItem,{key:"list-item"+e,index:e,details:i},l.createElement("div",{className:"queue-panel-list-row flex-grow flex-row"},l.createElement(x.Icon,{iconName:o,size:"medium",className:"queue-panel-list-icon margin-right-8"}),l.createElement("div",{className:"flex-column justify-center margin-left-4"},l.createElement("span",{className:"text-ellipsis primary-text"},a),l.createElement("span",{className:"flex-center flex-row font-size secondary-text text-ellipsis"},c&&l.createElement(x.Icon,{iconName:c,size:"small",className:"margin-right-4"}),l.createElement("span",null,r))),l.createElement("span",{className:"flex-grow flex-row justify-end"},l.createElement(x.Icon,{iconName:"ChevronRightMed",size:"medium"}))))},this._editResource=(e,t)=>{const i=t.data;s(i)?this.layoutManager.renderCallout((e=>l.createElement(ee.RepositoryResourcePanel,{pageContext:this.props.pageContext,resource:i,onDismiss:e,onUpdate:this.props.store.updateRepositoryResource}))):!function(e){const t=e;return void 0!==t.containerType&&void 0!==t.properties}(i)?!function(e){return void 0!==e.buildType}(i)?!function(e){return void 0!==e.packageType}(i)?this.layoutManager.renderCallout((e=>l.createElement(Z.PipelineResourcePanel,{pageContext:this.props.pageContext,store:this.props.store,resource:i,onDismiss:e,onUpdate:this.props.store.updatePipelineResource}))):this.layoutManager.renderCallout((e=>l.createElement(X.PackageResourcePanel,{pageContext:this.props.pageContext,store:this.props.store,resource:i,onDismiss:e,onUpdate:this.props.store.updatePackageResource}))):this.layoutManager.renderCallout((e=>l.createElement(G.BuildResourcePanel,{pageContext:this.props.pageContext,store:this.props.store,resource:i,onDismiss:e,onUpdate:this.props.store.updateBuildResource}))):this.layoutManager.renderCallout((e=>l.createElement(Y.ContainerResourcePanel,{pageContext:this.props.pageContext,store:this.props.store,resource:i,onDismiss:e,onUpdate:this.props.store.updateContainerResource})))},this._updateResources=()=>{const e=[];if(this.props.store.repositoryResources){const t=this.props.store.repositoryResources.value.filter((e=>!(0,n.equals)(e.alias,"self",!0)));e.push(...t)}if(this.props.store.pipelineResources){const t=this.props.store.pipelineResources.value;e.push(...t)}if(this.props.store.buildResources){const t=this.props.store.buildResources.value;e.push(...t)}if(this.props.store.containerResources){const t=this.props.store.containerResources.value;e.push(...t)}if(this.props.store.packageResources){const t=this.props.store.packageResources.value;e.push(...t)}this._resources.value=e},this._isLoading=new r.ObservableValue(!1),this._resources=new r.ObservableArray([])}componentDidMount(){this._initializeResources()}render(){return l.createElement(p.Panel,{backButtonProps:{onClick:this.props.onDismiss},contentClassName:"queue-panel-child no-padding",description:H.ResourcesDescriptionText,escDismiss:!0,footerButtonProps:[{text:H.CloseButtonLabel,onClick:this.props.onDismiss}],onDismiss:this.props.onDismiss,titleProps:{text:H.Resources}},l.createElement("div",{className:"queue-panel-list-container custom-scrollbar"},l.createElement(d.Observer,{loading:this._isLoading},(e=>e.loading?l.createElement("div",null,l.createElement(g.Spinner,{className:"queue-build-spinner"})):l.createElement(d.Observer,{errorMessage:this.props.store.errorMessage,resources:this._resources},(e=>e.errorMessage?l.createElement("div",{className:"margin-vertical-8 padding-horizontal-20"},l.createElement(h.MessageCard,{className:"multiline-error",severity:"Error"},e.errorMessage)):e.resources.length>0?l.createElement(u.List,{itemProvider:this._resources,renderRow:this._renderRow,width:"100%",singleClickActivation:!0,selection:this._listSelection,onActivate:this._editResource,initialPageCount:10}):l.createElement("div",{className:"margin-vertical-8 padding-horizontal-20"},l.createElement(h.MessageCard,{severity:"Info"},H.ResourcesNoResourcesText))))))))}_getSourceProvider(e){return this.props.pageContext.getService("ISourceProviderService").getSourceProvider(e.type)}async _initializeResources(){this.props.store.runParametersAreLoaded||(this._isLoading.value=!0,await this.props.store.fetchPipelineResources(),this._isLoading.value=!1),this._updateResources(),this.props.store.repositoryResources&&this.props.store.repositoryResources.subscribe(this._updateResources),this.props.store.pipelineResources&&this.props.store.pipelineResources.subscribe(this._updateResources),this.props.store.buildResources&&this.props.store.buildResources.subscribe(this._updateResources),this.props.store.containerResources&&this.props.store.containerResources.subscribe(this._updateResources),this.props.store.packageResources&&this.props.store.packageResources.subscribe(this._updateResources)}_getUpdatedRefTextAndIcon(e){return e.startsWith(z.GitConstants.RefsHeadsPrefix)?[e.substr(z.GitConstants.RefsHeadsPrefix.length),"OpenSource"]:e.startsWith(z.GitConstants.RefsTagsPrefix)?[e.substr(z.GitConstants.RefsTagsPrefix.length),"Tag"]:e.startsWith(z.GitConstants.RefsPrefix)?[e.substr(z.GitConstants.RefsPrefix.length),"OpenSource"]:[e.substr(0,z.GitConstants.ShortenedCommitHashLength),"BranchCommit"]}get layoutManager(){return this.props.pageContext.getService("IVssLayoutManager")}}t[e].ResourcesControllerView=i}("ResourcesControllerView"),function(e){se=t[e]={};class s extends l.Component{constructor(e){super(e),this._changeAllItems=(e,t)=>{void 0===t&&(t=!1);for(let e=0;e<this._stageOptions.length;e++)this._changeStageAt(e,!t);this._updateSelectAllState()},this._renderRow=(e,t,s)=>{const i=(0,S.getSafeId)(this.c_hiddenAriaDivId);return l.createElement(u.ListItem,{key:"list-item"+e,index:e,details:s},l.createElement("div",{className:"queue-panel-list-row flex-grow flex-row"},l.createElement("div",{className:"flex-column margin-right-8 justify-center"},l.createElement(T.Checkbox,{checked:!t.skip})),l.createElement("div",{className:"flex-column justify-center margin-left-4","aria-describedby":i},l.createElement("span",{className:"text-ellipsis primary-text","aria-label":t.name},t.name),l.createElement("span",{className:"font-size text-ellipsis secondary-text"},0===t.dependsOn.length?H.NoStageDependencies:(0,n.format)(H.DependsOn,t.dependsOn.join(", "))),l.createElement("div",{"aria-label":H.ListItemRoleDescription,id:i}))))},this._getMessageCard=(e,t)=>l.createElement("div",{className:"margin-vertical-8 padding-horizontal-20"},l.createElement(h.MessageCard,{className:"multiline-error",severity:e},t)),this._initializeStageOptions=()=>{const e=this.props.store.stageOptions;0===e.length?(this._loadingStages.value=!0,this._stageOptions.removeAll(),this.props.store.fetchPipelineStages().then((e=>{this._copyStageOptions(e),this._loadingStages.value=!1}))):this._copyStageOptions(e.value)},this._changeStageAt=(e,t)=>{const s=this._stageOptions.value[e];s.skip=t,this._stageOptions.change(e,s)},this._updateSelectAllState=()=>{0==this._skippedStages.length?this._runAllStagesValue.value=!0:this._skippedStages.length==this._stageOptions.length?this._runAllStagesValue.value=!1:this._runAllStagesValue.value=void 0},this._onStageSelectionChanged=(e,t)=>{this._changeStageAt(e,t),this._updateSelectAllState()},this._submitStageSelection=()=>{this.props.store.updateStageOptions(this._stageOptions.value),this.props.onDismiss()},this.c_hiddenAriaDivId="hiddenAriaDiv",this._loadingStages=new r.ObservableValue(!1),this._stageOptions=new r.ObservableArray([]),this._runAllStagesValue=new r.ObservableValue(!0),this._initializeStageOptions()}render(){return l.createElement(p.CustomPanel,{onDismiss:this.props.onDismiss},l.createElement(p.PanelHeader,{backButtonProps:{onClick:this.props.onDismiss},titleProps:{text:H.StagesToRun},description:H.StagesToRunSecondaryText,onDismiss:this.props.onDismiss}),l.createElement(p.PanelContent,{className:"queue-panel-child no-padding"},l.createElement("div",{className:"queue-panel-list-container custom-scrollbar"},l.createElement(d.Observer,{loading:this._loadingStages},(e=>e.loading?l.createElement("div",null,l.createElement(g.Spinner,{className:"queue-build-spinner"})):this._displayStageOptions())))),l.createElement(d.Observer,{stages:this._stageOptions},(e=>l.createElement(p.PanelFooter,{buttonProps:[{text:H.CancelButtonText,onClick:this.props.onDismiss},{text:H.UseSelectedStages,primary:!0,disabled:e.stages.length<=1||this._skippedStages.length===e.stages.length,onClick:this._submitStageSelection}]}))))}_displayStageOptions(){return l.createElement(d.Observer,{errorMessage:this.props.store.errorMessage,stages:this._stageOptions},(e=>{const t=e.stages.length;return e.errorMessage?this._getMessageCard("Error",e.errorMessage):t>1?l.createElement(l.Fragment,null,l.createElement(T.TriStateCheckbox,{label:H.RunAllStages,className:"run-all-stages-checkbox",checked:this._runAllStagesValue,onChange:this._changeAllItems,triState:!0}),l.createElement("div",{className:"v-scroll-auto custom-scrollbar"},l.createElement(u.ScrollableList,{itemProvider:this._stageOptions,renderRow:this._renderRow,width:"100%",singleClickActivation:!0,onActivate:(e,t)=>this._onStageSelectionChanged(t.index,!t.data.skip)}),this._skippedStages.length>0&&this._getMessageCard("Warning",H.SkippedStagesWarning))):1===t?this._getMessageCard("Info",H.SingleStagePipeline):this._getMessageCard("Error",H.UnableToLoadStages)}))}_copyStageOptions(e){this._stageOptions.value=e.map((e=>Object.assign({},e)))}get _skippedStages(){return this._stageOptions.value.filter((e=>e.skip))}}t[e].StageOptionsControllerView=s}("StageOptionsControllerView"),function(e){ie=t[e]={};class s extends l.Component{constructor(e){super(e),this._initializeResources=async()=>{this.props.store.templateParametersAreLoaded||(this._isLoading.value=!0,await this.props.store.fetchPipelineTemplateParameters(),this._isLoading.value=!1)},this._isLoading=new r.ObservableValue(!1),this._templateParameters=e.store.templateParameters}componentDidMount(){this._templateParameters&&(this._initializeResources(),this._templateParameters.subscribe((()=>this._initializeResources())))}render(){return l.createElement(d.Observer,{loading:this._isLoading,templateParameters:this._templateParameters},(e=>e.loading?l.createElement("div",{className:(0,S.css)(this.props.className,"flex-row justify-start")},l.createElement(g.Spinner,{orientation:0,label:H.ProcessingYamlMessage})):e.templateParameters&&e.templateParameters.length>0?l.createElement("div",{className:(0,S.css)(this.props.className,"flex-column flex-noshrink rhythm-vertical-16")},e.templateParameters.map((e=>l.createElement(i,{key:e.data.name,onValueChanged:this.props.store.updateTemplateParameter,templateParameter:e})))):null))}}t[e].TemplateParametersView=s;const i=e=>{switch(e.templateParameter.data.type){case 3:return l.createElement(n,Object.assign({},e));case 0:return l.createElement(a,Object.assign({},e));case 2:return l.createElement(a,Object.assign({},e,{inputType:"number"}));case 5:return l.createElement(o,Object.assign({},e));case 4:return l.createElement(c,Object.assign({},e));default:return l.createElement(a,Object.assign({},e,{multiline:!0}))}},a=e=>{const{onValueChanged:t,templateParameter:s,multiline:i=!1,inputType:a="text"}=e,{data:r,value:n,errorMessage:o}=s,c=r.default?r.displayName||r.name:l.createElement("div",{className:"flex-row"},l.createElement("div",{className:"flex-grow"},r.displayName||r.name),l.createElement("div",{className:"secondary-text"},H.RequiredLabel));return l.createElement(C.FormItem,{className:"flex-stretch flex-noshrink",error:!!o,label:c,message:o},l.createElement(v.TextField,{autoAdjustHeight:i,inputType:a,multiline:i,onChange:(e,s)=>t({data:r,value:s,errorMessage:o}),placeholder:r.default,value:n}))},n=e=>{const{onValueChanged:t,templateParameter:s}=e,{data:i,value:a,errorMessage:r}=s;return l.createElement(T.Checkbox,{checked:"true"===a.toLowerCase(),className:"flex-stretch flex-noshrink padding-horizontal-0",label:i.displayName||i.name,onChange:(e,s)=>{t({data:i,value:s?"true":"false",errorMessage:r})}})},o=e=>{const{onValueChanged:t,templateParameter:s}=e,{data:i,value:a,errorMessage:r}=s;if(!i.values||0===i.values.length)return null;const n=i.values.map((e=>({id:e,text:e}))),o=new N.DropdownSelection,c=i.values.findIndex((e=>e===a)),u=c>-1?c:0;o.select(u);const h=i.displayName||i.name;return l.createElement(C.FormItem,{className:"flex-stretch flex-noshrink",label:h},l.createElement(w.Dropdown,{ariaLabel:h,items:n,onSelect:(e,s)=>{t({data:i,value:s.text||"",errorMessage:r})},selection:o}))},c=e=>{const{onValueChanged:t,templateParameter:s}=e,{data:i,value:a,errorMessage:r}=s;if(!i.values||0===i.values.length)return null;const n=a||i.default,o=i.displayName||i.name;return l.createElement(B.RadioButtonGroup,{className:"flex-noshrink",onSelect:e=>{t({data:i,value:e,errorMessage:r})},selectedButtonId:n,text:o},i.values.map(((e,t)=>l.createElement(B.RadioButton,{key:`radio-button-${i.name}-${t}`,id:e,text:e}))))}}("TemplateParametersView"),function(e){ae=t.VariablePanel={};class s extends l.Component{constructor(e){super(e),this._onKeyDown=e=>{const t=this._getDuplicateValidationMessage(),s=!this._isValidVariableName()||""!==t;"Enter"!==e.key||e.defaultPrevented||s||(this._clickOk(),e.preventDefault())},this._isValidVariableName=()=>{const e=this.state.variable.name;return!!e&&""!==e.trim()},this._isUnchangedVariableValue=()=>!this.props.isNewVariable&&this._originalVariableValue===this.state.variable.value,this._getDuplicateValidationMessage=()=>{const e=this.state.variable,t=e.name?e.name.trim().toLocaleLowerCase():"";return this._getDuplicateVariableNamesMap()[t]>1?(0,n.format)(H.DuplicateVariableMessage,e.name):""},this._getDuplicateVariableNamesMap=()=>{let e={};if(!this.props.runtimeVariables)return e;return(this.props.isNewVariable?this.props.runtimeVariables.value.concat([this.state.variable]):this.props.runtimeVariables.value).forEach((t=>{if(t&&t.name){let s=t.name?t.name.trim().toLocaleLowerCase():"";e.hasOwnProperty(s)?e[s]++:e[s]=1}})),e},this._clickOk=()=>{this.props.isNewVariable&&this.props.onVariableAdded?this.props.onVariableAdded(this.state.variable):!this.props.isNewVariable&&this.props.onVariableUpdated&&this.props.onVariableUpdated(this.state.variable),this.props.onDismiss()},this._onNameChanged=(e,t)=>{this.state.variable.name=t,this.setState({variable:this.state.variable})},this._onValueChanged=(e,t)=>{this.state.variable.value=t,this.setState({variable:this.state.variable})},this.state={variable:this.props.variable},this._originalVariableValue=this.props.isNewVariable?void 0:this.props.variable.value}render(){const e=this.props.isNewVariable?H.AddVariablePanelTitle:H.UpdateVariablePanelTitle,t=this.props.isNewVariable?H.CreateButtonText:H.UpdateButtonText,s=this._getDuplicateValidationMessage(),a=!this._isValidVariableName()||""!==s,r=this.props.isNewVariable?".variable-panel-variable-name-input":".variable-panel-variable-value-input";return l.createElement(p.Panel,{backButtonProps:{subtle:!0,iconProps:{iconName:"Back"},ariaLabel:H.Back,onClick:this.props.onDismiss},onDismiss:this.props.onDismiss,escDismiss:!0,titleProps:{text:e},className:"variable-panel",defaultActiveElement:r,footerButtonProps:[{text:H.CancelButtonText,onClick:this.props.onDismiss},{text:t,primary:!0,onClick:this._clickOk,disabled:a||this._isUnchangedVariableValue()}]},l.createElement(i,{variable:this.props.variable,isNewVariable:this.props.isNewVariable,validationMessage:s,onNameChanged:this._onNameChanged,onValueChanged:this._onValueChanged,onKeyDown:this._onKeyDown}))}}t.VariablePanel.VariablePanel=s;class i extends l.Component{constructor(e){super(e),this._getVariableNameControl=()=>l.createElement(C.FormItem,{className:"flex-grow margin-bottom-16",label:l.createElement(K.FormInputLabel,{primaryLabel:H.NameFieldLabel,secondaryLabel:H.RequiredLabel}),error:""!==this.props.validationMessage,message:this.props.validationMessage},l.createElement(v.TextField,{ariaLabel:H.NameFieldLabel,ref:e=>{this._nameTextFieldRef=e},value:this.props.variable.name,inputClassName:"variable-panel-variable-name-input",onChange:this.props.onNameChanged,disabled:this.props.variable.disableDelete,required:!0})),this._getVariableValueControl=()=>{const e=this.props.variable,t=e.isSecret?"password":"text",s=e.isSecret&&null===e.value?this.c_secretVariableFillerText:e.value;return l.createElement(C.FormItem,{label:H.ValueFieldLabel,className:"flex-grow margin-bottom-8"},l.createElement(v.TextField,{value:s,inputClassName:"variable-panel-variable-value-input",ref:e=>{this._valueTextFieldRef=e},inputType:t,onChange:this.props.onValueChanged}))},this._getVariableSecretControl=()=>{const e=!!this.props.variable&&this.props.variable.isSecret;return l.createElement(T.Checkbox,{className:"no-h-padding",label:H.SecretFieldLabel,checked:e,disabled:!0})},this.c_secretVariableFillerText="*****",this.state={variable:this.props.variable}}render(){return l.createElement("div",{className:"variable-panel-content flex-grow",onKeyDown:this.props.onKeyDown},this._getVariableNameControl(),this._getVariableValueControl(),!this.props.isNewVariable&&this.props.variable&&this.props.variable.isSecret&&this._getVariableSecretControl())}componentDidMount(){this.props.isNewVariable?(this._nameTextFieldRef&&this._nameTextFieldRef.focus(),this._nameTextFieldRef&&this._nameTextFieldRef.select()):(this._valueTextFieldRef&&this._valueTextFieldRef.focus(),this._valueTextFieldRef&&this._valueTextFieldRef.select())}}}(),function(e){re=t[e]={};class s extends l.Component{constructor(e){super(e),this._listSelection=new u.ListSelection,this.c_hiddenAriaDivId="hiddenAriaDiv",this._onKeyDown=e=>{if("delete"===e.key.toLowerCase()&&this._listSelection.selectedCount>0){const t=this._listSelection.value[0].beginIndex;this._itemProvider.value[t].disableDelete||(this.props.store.deleteVariable(t),e.preventDefault())}},this._renderRow=(e,t,s)=>{const i=t.name?(0,n.format)(H.DeleteButtonTooltip,t.name):H.DeleteButtonEmptyTooltip,a=t.isSecret?A.VariableSecretMask:"= "+t.value,r=t.isSecret?"Lock":"Variable",o=(0,S.getSafeId)(this.c_hiddenAriaDivId);return l.createElement(u.ListItem,{key:"list-item"+e,index:e,details:s},l.createElement("div",{className:"queue-panel-list-row flex-grow flex-row"},l.createElement(x.Icon,{iconName:r,size:"medium",className:"queue-panel-list-icon margin-right-8"}),l.createElement("div",{className:"flex-column justify-center margin-left-4","aria-describedby":o},l.createElement("span",{className:"text-ellipsis primary-text","aria-label":t.name},t.name),l.createElement("span",{className:"font-size text-ellipsis secondary-text","aria-label":a},a),l.createElement("div",{"aria-label":H.ListItemRoleDescription,id:o})),l.createElement("span",{className:"flex-grow flex-row justify-end"},!t.disableDelete&&l.createElement("div",{className:"flex-column justify-center margin-right-16"},l.createElement(c.Button,{ariaLabel:i,className:"bolt-list-cell-content-reveal",iconProps:{iconName:"Delete"},onClick:t=>{this.props.store.deleteVariable(e),t.preventDefault()},subtle:!0,tooltipProps:{text:i}})),l.createElement(x.Icon,{iconName:"ChevronRightMed",size:"medium"}))))},this._createVariable=()=>{this._renderVariablePanel({},this.props.store.runtimeVariables.length,!0)},this._updateVariable=(e,t)=>{this._renderVariablePanel(Object.assign({},t.data),t.index,!1)},this._renderVariablePanel=(e,t,s)=>{this.props.pageContext.getService("IVssLayoutManager").renderCallout((i=>l.createElement(ae.VariablePanel,{isNewVariable:s,onDismiss:i,onVariableAdded:e=>this.props.store.addVariable(e),onVariableUpdated:e=>this.props.store.updateVariable(e,t),runtimeVariables:this.props.store.runtimeVariables,variable:e})))},this._itemProvider=this.props.store.runtimeVariables}render(){return l.createElement(p.Panel,{backButtonProps:{onClick:this.props.onDismiss},contentClassName:"queue-panel-child no-padding",description:this.props.pipelineName,escDismiss:!0,footerButtonProps:this.getFooterButtonProps(),onDismiss:this.props.onDismiss,titleProps:{text:H.VariablesTitle}},l.createElement("div",{className:"queue-panel-list-container"},l.createElement("div",{className:"flex-row scroll-auto",onKeyDown:this._onKeyDown},l.createElement(u.ScrollableList,{ariaLabel:H.VariablesTitle,itemProvider:this._itemProvider,renderRow:this._renderRow,width:"100%",singleClickActivation:!0,selection:this._listSelection,onActivate:this._updateVariable,outerClassName:"custom-scrollbar"})),l.createElement(d.Observer,{variables:this._itemProvider},(e=>0===e.variables.length?l.createElement("span",{className:"flex-row margin-vertical-8 padding-horizontal-20 primary-text"},this._renderEmptyVariableMessage()):null))))}_renderEmptyVariableMessage(){return this.props.enforceSettableVar?l.createElement(l.Fragment,null,l.createElement("label",{className:"margin-right-4"},H.EnforcedEmptyVariablesDescription),l.createElement(y.Link,{href:"https://aka.ms/AzPipelines/SettingVariablesAtQueueTime",ariaLabel:H.VariablesLearnMore},H.LearnMoreMessage)):l.createElement(l.Fragment,null,l.createElement("label",{className:"margin-right-4"},H.EmptyVariablesDescription),l.createElement(y.Link,{href:"https://go.microsoft.com/fwlink/?linkid=2087183",ariaLabel:H.VariablesLearnMore},H.LearnMoreMessage))}getFooterButtonProps(){const e=[{text:H.AddVariableButton,primary:!0,onClick:this._createVariable}];return(0,o.isFeatureFlagEnabled)(this.props.pageContext,"Build2.DisableRunTimeVariableEdit",!1)&&this.props.enforceSettableVar?[]:e}}t[e].VariablesControllerView=s}("VariablesControllerView"),function(e){t.QueuePanel={};const s="refs/heads/",i="refs/tags/";class o extends l.Component{constructor(e){super(e),this._advancedOptionsItemProvider=new r.ObservableArray([]),this._advancedOptionsListSelection=new u.ListSelection,this._showPanel=!1,this._showError=!1,this._errorMessage="",this._enableDiagnostic=!1,this._agentSpecificationServiceErrorMessage=new r.ObservableValue(""),this._agentSpecifications=new r.ObservableArray,this._isLoadingAgentSpecifications=new r.ObservableValue(!1),this._runButtonDisabled=new r.ObservableValue(!0),this._saveCommentText=new r.ObservableValue(""),this._queueActionPending=new r.ObservableValue(!1),this._timerManagement=new E.TimerManagement,this._pendingOverlayTimeoutId=0,this._isTfsGit=!1,this._commentTextFieldRef=l.createRef(),this._overflowing=!1,this._observingOverflow=!1,this._intersectionCallbackRegistered=!1,this._wasDefinitionPreviouslySaved=!1,this._stageChooserDisabled=!1,this._enforceSettableVar=!1,this._renderAdvancedOptionRow=(e,t,s)=>{const i=this._advancedOptionsListSelection.selectable(e),a=i?t.secondaryText:H.DisabledDueToInvalidTemplateParametersMessage;return l.createElement(u.ListItem,{className:i?"cursor-pointer":"advanced-option-disabled",key:"list-item"+e,index:e,details:s},l.createElement("div",{className:"row-width flex-grow flex-row padding-horizontal-20"},l.createElement("div",{className:"text-width flex-column flex-grow padding-vertical-8"},l.createElement("span",{className:"primary-text"},t.primaryText),l.createElement("span",{className:"flex-row scroll-hidden flex-center font-size-ms secondary-text"},a)),l.createElement(x.Icon,{iconName:"ChevronRightMed",size:"medium"})))},this._onFetchRepoError=e=>{this._showError=!0,this._errorMessage=e,this._messageSeverity="Error",this.setState(this._getState())},this._onSaveCommentChange=(e,t)=>{this._saveCommentText.value=t},this._branchSelected=e=>{this._sourceVersionActionCreator.updateBranch(e)},this._branchSelectedForCommit=e=>{this._queueBuildStore.updateBranchForCommit(e)},this._versionSelected=e=>{this._sourceVersionActionCreator.updateVersion(e)},this._tagSelected=e=>{this._sourceVersionActionCreator.updateTag(e)},this._shelvesetSelected=e=>{this._sourceVersionActionCreator.updateShelveset(e)},this._dismissPanel=()=>{this._shortcutService.setShortcutsEnabled(!0),this._showPanel=!1,this.setState(this._getState()),this.props.onDismiss()},this._storeChanged=()=>{this._selectedAgentQueue=this._queueBuildStore.getSelectedQueue(),this._sourceVersion=this._queueBuildStore.getSourceVersion(),this._shelvesetName=this._queueBuildStore.getShelvesetName(),this._currentCommit=this._queueBuildStore.getSourceVersion(),this._enableDiagnostic=this._queueBuildStore.getEnableDiagnosticState(),this.setState(this._getState())},this._queueStoreChanged=()=>{this._queues=this._queueStore.getQueues()||[],this.setState(this._getState())},this._queueBuild=()=>{this._shortcutService.setShortcutsEnabled(!0),this._pendingOverlayTimeoutId=this._timerManagement.setTimeout(this._showOverlay,250),this._runButtonDisabled.value=!0;let e=Promise.resolve(this._buildDefinition),t=!1;this.props.isSaveEnabled&&this.props.onSave&&(e=this.props.onSave(this._saveCommentText.value),t=!0);const s=this._queueBuildStore.getShelvesetName(),i=this._queueBuildStore.getModifiedRepositoryResources();let r;i.length>0&&(r={},i.forEach((e=>{r[e.alias]={refName:e.refName,version:e.version}})));const n=this._queueBuildStore.getModifiedPipelineResources();let o;n.length>0&&(o={},n.forEach((e=>{o[e.alias]={version:e.version}})));const l=this._queueBuildStore.getModifiedBuildResources();let c;l.length>0&&(c={},l.forEach((e=>{c[e.alias]={version:e.version}})));const u=this._queueBuildStore.getModifiedContainerResources();let h;u.length>0&&(h={},u.forEach((e=>{h[e.alias]={version:e.version}})));const d=this._queueBuildStore.getModifiedPackageResources();let p;d.length>0&&(p={},d.forEach((e=>{p[e.alias]={version:e.version}}))),e.then((e=>{const i=this._queueStore.getSelectedQueue(),n=i?i.id:-1,l={isYaml:this._isYamlBuildDefinition(),definitionId:this.props.definitionId,agentQueueId:n,ignoreWarnings:"Warning"===this.state.messageSeverity,projectId:this.props.projectId,pageContext:this.props.pageContext,variables:this._queueBuildStore.getRunTimeVariables(),serializedVariables:this._queueBuildStore.getSerializedVariables(),demands:this._queueBuildStore.getDemandsValues(),sourceBranch:s||this._queueBuildStore.getSourceBranch(),sourceVersion:this._queueBuildStore.getSourceVersion()||void 0,stagesToSkip:this._queueBuildStore.skippedStageNames,repositoryResources:r,pipelineResources:o,buildResources:c,containerResources:h,packageResources:p,templateParameters:this._queueBuildStore.getTemplateParametersDictionary(),agentSpecification:this._selectedAgentSpecification};t&&!s&&e&&e.repository&&e.repository.type.toLowerCase()===a.RepositoryTypes.TfsVersionControl.toLowerCase()&&(l.sourceBranch=e.repository.defaultBranch),this._actionCreator.queueBuild(l)})).catch((e=>{this._timerManagement.clearTimeout(this._pendingOverlayTimeoutId);let t="";e&&(t=e.message||e),this._showError=!0,this._errorMessage=t,this._messageSeverity="Error",this.setState(this._getState())}))},this._onSelectedQueueChanged=e=>{e&&(this._selectedAgentSpecification=void 0,this._queueActionCreator.selectQueue(e),this._updateAgentSpecifications(e))},this._onToggleEnableDiagnostic=(e,t)=>{this._enableDiagnosticActionCreator.toggleEnableDiagnostic(t)},this._onSelectedAgentSpecificationChanged=e=>{this._selectedAgentSpecification=e,this._agentSpecificationServiceErrorMessage.value="",this._runButtonDisabled.value=!1,this.setState(this._getState())},this._showOverlay=()=>{this._showPanel&&(this._queueActionPending.value=!0)},this._handleBuildQueued=e=>{this._publishQueueBuildTelemetry(),this._timerManagement.clearTimeout(this._pendingOverlayTimeoutId),e.buildId?this._onSuccess(e.buildId):(this._queueActionPending.value=!1,this._showError=!0,this._errorMessage=e.message||"",this._messageSeverity=e.messageSeverity||"Info",this._runButtonDisabled.value=!1,this.setState(this._getState()))},this._onSuccess=e=>{const t=this.props.pageContext.getService("IBuildLinkingService").getBuildUrl(e);(0,M.onClickFPS)(this.props.pageContext,t,!0)},this._observeElement=e=>{e&&this._intersectionContext&&!this._observingOverflow&&(this._intersectionContext.observe(e),this._observedElement=e,this._observingOverflow=!0)},this._onIntersect=e=>{const t=e.find((e=>e.target===this._observedElement));if(t){const e=Math.round(t.rootBounds.bottom)<Math.round(t.boundingClientRect.bottom);e!==this._overflowing&&(this._overflowing=e,this.setState(this._getState()))}},this._registerAdvancedOptions=()=>{const e=this._isYamlBuildDefinition(),t=[];t.push({component:re.VariablesControllerView,primaryText:H.VariablesTitle,props:{pageContext:this.props.pageContext,pipelineName:this._buildDefinition.name,store:this._queueBuildStore,enforceSettableVar:this._enforceSettableVar},requiresFullYamlParse:!1,secondaryText:l.createElement(d.Observer,{variables:this._queueBuildStore.runtimeVariables},(e=>l.createElement("span",null,0===e.variables.length?H.VariablesEmptySecondaryText:1===e.variables.length?H.VariablesOneSecondaryText:(0,n.format)(H.VariablesManySecondaryText,e.variables.length))))}),e||t.push({component:J.DemandsControllerView,primaryText:H.DemandsTitle,props:{pageContext:this.props.pageContext,pipelineName:this._buildDefinition.name,store:this._queueBuildStore},requiresFullYamlParse:!1,secondaryText:l.createElement(d.Observer,{demands:this._queueBuildStore.demands},(e=>l.createElement("span",null,0===e.demands.length?H.DemandsEmptySecondaryText:1===e.demands.length?H.DemandsOneSecondaryText:(0,n.format)(H.DemandsManySecondaryText,e.demands.length))))}),e&&!this._stageChooserDisabled&&this._wasDefinitionPreviouslySaved&&t.push({component:se.StageOptionsControllerView,primaryText:H.StagesToRun,props:{pageContext:this.props.pageContext,store:this._queueBuildStore,pipelineId:this.props.definitionId},requiresFullYamlParse:!0,secondaryText:l.createElement(d.Observer,{stageOptions:this._queueBuildStore.stageOptions},(e=>{const t=e.stageOptions.filter((e=>e.skip)).length,s=e.stageOptions.filter((e=>!e.skip)).map((e=>e.name));return l.createElement("span",null,0===t?H.StageOptionsRunAsConfigured:s.join(", "))}))}),e&&this._wasDefinitionPreviouslySaved&&(this._queueBuildStore.repositoryResources||this._queueBuildStore.pipelineResources||this._queueBuildStore.buildResources||this._queueBuildStore.containerResources||this._queueBuildStore.packageResources)&&t.push({component:te.ResourcesControllerView,primaryText:H.Resources,props:{pageContext:this.props.pageContext,store:this._queueBuildStore,pipelineId:this.props.definitionId},requiresFullYamlParse:!0,secondaryText:l.createElement(d.Observer,{repositoryResources:this._queueBuildStore.repositoryResources,pipelineResources:this._queueBuildStore.pipelineResources,buildResources:this._queueBuildStore.buildResources,containerResources:this._queueBuildStore.containerResources,packageResources:this._queueBuildStore.packageResources},(e=>{let t="";if(this._queueBuildStore.runParametersAreLoaded){const s=e.repositoryResources&&e.repositoryResources.filter((e=>!(0,n.equals)(e.alias,"self",!0))),i=e.pipelineResources,a=e.buildResources,r=e.containerResources,o=e.packageResources,l=s?1===s.length?H.ResourceCountRepository:(0,n.format)(H.ResourceCountRepostiories,s.length):"",c=i?1===i.length?H.ResourceCountPipelineRun:(0,n.format)(H.ResourceCountPipelineRuns,i.length):"",u=a?1===a.length?H.ResourceCountBuildRun:(0,n.format)(H.ResourceCountBuildRuns,a.length):"",h=r?1===r.length?H.ResourceCountContainerRun:(0,n.format)(H.ResourceCountContainerRuns,r.length):"",d=o?1===o.length?H.ResourceCountPackageRun:(0,n.format)(H.ResourceCountPackageRuns,o.length):"";t=l&&c&&u&&d?(0,n.format)("{0}, {1}, {2}, {3}, {4}",l,c,u,h,d):l||c||u||d||H.ResourcesUseLatestText}else t=H.ResourcesUseLatestText;return l.createElement(R.Tooltip,{overflowOnly:!0},l.createElement("span",{className:"text-ellipsis"},t))}))}),this._advancedOptionsItemProvider.value=t,e&&this._queueBuildStore.templateParameters&&(this._onTemplateParametersValidityUpdate(this._queueBuildStore.templateParametersAreValid.value),this._queueBuildStore.templateParametersAreValid.subscribe(this._onTemplateParametersValidityUpdate))},this._onTemplateParametersValidityUpdate=e=>{if(e)this._advancedOptionsListSelection.clearUnselectable();else{const e=this._advancedOptionsItemProvider.value;for(let t=0;t<e.length;t++)e[t].requiresFullYamlParse&&this._advancedOptionsListSelection.addUnselectable(t)}},this._onAdvancedOptionSelected=(e,t)=>{this.props.pageContext.getService("IVssLayoutManager").renderCallout((e=>l.createElement(t.data.component,Object.assign(Object.assign({},t.data.props),{onDismiss:e}))))},this._getState=()=>({showPanel:this._showPanel,showError:this._showError,errorMessage:this._errorMessage,messageSeverity:this._messageSeverity,isRootPath:!1,queues:this._queues,selectedAgentQueue:this._selectedAgentQueue,sourceVersion:this._sourceVersion,shelvesetName:this._shelvesetName,currentCommit:this._currentCommit,agentSpecifications:this._agentSpecifications?this._agentSpecifications.value:[],selectedAgentSpecification:this._selectedAgentSpecification,isLoadingAgentSpecifications:!!this._isLoadingAgentSpecifications&&this._isLoadingAgentSpecifications.value,enableDiagnostic:this._enableDiagnostic,overflowing:this._overflowing}),this._shortcutService=e.pageContext.getService("IVssKeyboardShortcutService"),this._showPanel=e.showPanel,this._wasDefinitionPreviouslySaved=this.props.definitionId>0,this.props.runtimeVariables&&this.props.runtimeVariables.length>0&&this.props.runtimeVariables.forEach((e=>{e.variable.disableDelete=void 0===e.variable.disableDelete||e.variable.disableDelete})),this._isTfsGit=!(!this.props.buildRepository||!this.props.buildRepository.type||this.props.buildRepository.type.toLowerCase()!==a.RepositoryTypes.TfsGit.toLowerCase()),this._actionHub=new Q.QueueBuildActionHub,this._actionCreator=new Q.QueueBuildActionCreator({actionHub:this._actionHub});let t=(0,O.getSingletonManager)().get(I.QueueStore.key);t?this._queues=t.getQueues():(this._queueActionHub=new I.QueueActionHub,t=new I.QueueStore({pageContext:e.pageContext,project:e.projectId,actionHub:this._queueActionHub}),(0,O.getSingletonManager)().add(I.QueueStore.key,t)),this._queueStore=t,this._queueActionHub=t.getActionHub(),this._queueActionCreator=new I.QueueActionCreator({actionHub:this._queueActionHub,source:new q.QueueSource({pageContext:this.props.pageContext,project:this.props.projectId})});let s=(0,O.getSingletonManager)().get(W.QueueBuildStore.key);s?(this._sourceVersionActionHub=s.getSourceControlSelectorActionHub(),this._shelvesetPickerActionHub=s.getShelvesetPickerActionHub(),this._enableDiagnosticActionHub=s.getEnableDiagnosticActionHub(),e.buildDefinition?s.updateBuildDefinition(e.buildDefinition,e.runtimeVariables,void 0,e.previousTemplateParameters):s.updateDefinition(e.definitionId,e.runtimeVariables,e.sourceBranch,!1,e.buildRepository,e.definitionVariables,e.previousTemplateParameters)):(this._sourceVersionActionHub=new Q.SourceVersionActionHub,this._shelvesetPickerActionHub=new k.ShelvesetPickerActionHub,this._enableDiagnosticActionHub=new Q.EnableDiagnosticActionHub,s=new W.QueueBuildStore({pageContext:e.pageContext,projectId:e.projectId,definitionId:e.definitionId,buildDefinition:e.buildDefinition,sourceBranch:e.sourceBranch,runtimeVariables:this.props.runtimeVariables,previousTemplateParameters:this.props.previousTemplateParameters||{},definitionVariables:this.props.definitionVariables,sourceVersionActionHub:this._sourceVersionActionHub,shelvesetPickerActiobHub:this._shelvesetPickerActionHub,enableDiagnosticActionHub:this._enableDiagnosticActionHub,queueActionHub:this._queueActionHub,buildRepository:e.buildRepository}),(0,O.getSingletonManager)().add(W.QueueBuildStore.key,s)),this._queueBuildStore=s,this._sourceVersionActionCreator=new Q.SourceVersionActionCreator({actionHub:this._sourceVersionActionHub}),this._enableDiagnosticActionCreator=new Q.EnableDiagnosticActionCreator({actionHub:this._enableDiagnosticActionHub}),this.state=this._getState(),this._queueBuildStore.fetchDemands(),Promise.all([this._setupAgentSpecifications(),this._setupOrgSettings(),this._setupProjectSettings()]).then((()=>this._registerAdvancedOptions()))}componentDidMount(){this._actionHub.buildQueued.addListener(this._handleBuildQueued),this._queueStore.addListener(this._queueStoreChanged),this._queueBuildStore.addListener(this._storeChanged)}componentWillUnmount(){this._actionHub.buildQueued.removeListener(this._handleBuildQueued),this._queueStore.removeListener(this._queueStoreChanged),this._queueBuildStore.removeListener(this._storeChanged),this._timerManagement.dispose(),this._intersectionContext&&this._intersectionContext.unregister(this._onIntersect)}componentDidUpdate(){this._intersectionContext&&!this._intersectionCallbackRegistered&&(this._intersectionContext.register(this._onIntersect),this._intersectionCallbackRegistered=!0),this.props.isSaveEnabled&&this._commentTextFieldRef&&this._commentTextFieldRef.current&&this._commentTextFieldRef.current.focus()}render(){const e=this._isYamlBuildDefinition(),t=!this._buildDefinition,s=this._getRunButtonText(),i=[],a=e&&!!this._queueBuildStore.templateParameters&&this._wasDefinitionPreviouslySaved;return i.push({id:"queue-panel-close-button",onActivate:this._dismissPanel,ariaLabel:H.CloseButtonLabel,iconProps:{iconName:"Cancel"},subtle:!0,role:"button"}),this._shortcutService.setShortcutsEnabled(!1),l.createElement(d.Observer,{isPanelOpen:this._showPanel,queueActionPending:this._queueActionPending},(r=>r.isPanelOpen?l.createElement(p.CustomPanel,{className:"queue-panel flex-column h-scroll-hidden",lightDismiss:!r.queueActionPending,onDismiss:this._dismissPanel},l.createElement(U.Header,{className:"bolt-panel-header title-m",commandBarItems:i,title:H.QueuePanelTitleNoDefinition,description:H.QueuePanelDescription}),l.createElement(p.PanelContent,null,l.createElement(j.Intersection,null,l.createElement("div",{className:(0,S.css)(this.state.overflowing&&"bottom-border","custom-scrollbar flex-column flex-grow v-scroll-auto")},l.createElement(j.IntersectionContext.Consumer,null,(s=>(this._intersectionContext=s,l.createElement("div",{className:"flex-column flex-grow",ref:e=>this._observeElement(e)},l.createElement(d.Observer,{storeError:this._queueBuildStore.errorMessage},(e=>e.storeError?l.createElement("div",{className:"margin-vertical-8 padding-horizontal-20"},l.createElement(h.MessageCard,{severity:"Error"},l.createElement("span",{className:"multiline-error"},e.storeError))):null)),this.state.showError&&l.createElement("div",{className:"margin-vertical-8 padding-horizontal-20"},l.createElement(h.MessageCard,{severity:this.state.messageSeverity},l.createElement("span",{className:"multiline-error"},this.state.errorMessage))),r.isPanelOpen&&!t&&l.createElement(l.Fragment,null,l.createElement("div",{className:"padding-horizontal-20"},!e&&l.createElement(l.Fragment,null,this._getSaveCommentContent(),this._getAgentPools()),this._getBranchControl()),l.createElement("div",{className:"flex-column rhythm-vertical-16"},a&&l.createElement(ie.TemplateParametersView,{className:"padding-horizontal-20",store:this._queueBuildStore}),l.createElement("label",{role:"heading",className:"padding-horizontal-20 primary-text title-s"},H.AdvancedOptionsLabel),l.createElement(u.List,{ariaLabel:H.AdvancedOptionsLabel,itemProvider:this._advancedOptionsItemProvider,onSelect:this._onAdvancedOptionSelected,renderRow:this._renderAdvancedOptionRow,selection:this._advancedOptionsListSelection,width:"100%"}))),t&&r.isPanelOpen&&l.createElement(g.Spinner,{className:"queue-build-spinner"})))))))),l.createElement(p.PanelFooter,{className:"flex-row"},l.createElement(T.Checkbox,{label:H.RunWithDiagnostics,className:"flex-grow margin-right-8",onChange:this._onToggleEnableDiagnostic,checked:this.state.enableDiagnostic}),l.createElement(F.ButtonGroup,{className:"bolt-panel-footer-buttons"},l.createElement(c.Button,{text:H.CancelButtonText,onClick:this._dismissPanel}),l.createElement(d.Observer,{runButtonDisabled:this._runButtonDisabled,templateParametersAreValid:this._queueBuildStore.templateParametersAreValid},(e=>l.createElement(c.Button,{text:s,primary:!0,onClick:this._queueBuild,disabled:e.runButtonDisabled||a&&!e.templateParametersAreValid}))))),r.queueActionPending&&l.createElement(p.PanelOverlay,{overlayContent:l.createElement(g.Spinner,{label:H.StartingRun})})):null))}async _setupAgentSpecifications(){return this._agentSpecificationService=this.props.pageContext.getService("IAgentSpecificationService"),this._queueBuildStore.fetchBuildDefinition().then((e=>{this._buildDefinition=e;const t=e.queue;if(t&&e.project&&(this._selectedAgentQueue={id:t.id,name:t.name,pool:t.pool,projectId:e.project.id}),this._queueActionCreator.selectQueue(this._selectedAgentQueue),!this._isYamlBuildDefinition()){this._updateAgentSpecifications(this._selectedAgentQueue);const t=e.process;t&&t.target&&t.target.agentSpecification&&(this._selectedAgentSpecification=t.target.agentSpecification)}this._runButtonDisabled.value=!1,this.setState(this._getState())})).catch((e=>{e&&e.message&&(this._errorMessage=e.message,this._showError=!0,this.setState(this._getState()))}))}async _setupOrgSettings(){return this._queueBuildStore.fetchOrgSettings().then((e=>{e&&(this._stageChooserDisabled=e.disableStageChooser)}))}async _setupProjectSettings(){return this._queueBuildStore.fetchProjSettings().then((e=>{e&&(this._enforceSettableVar=e.enforceSettableVar.enabled)}))}_isYamlBuildDefinition(){return!(!this._buildDefinition||!this._buildDefinition.process)&&this._buildDefinition.process.type===o.YamlProcessType}_updateAgentSpecifications(e){this._isLoadingAgentSpecifications.value=!0,this._runButtonDisabled.value=!0,this.setState(this._getState()),this._agentSpecificationService.getAgentSpecificationsByQueue(e).then((e=>{this._agentSpecificationServiceErrorMessage.value="",this._agentSpecifications.removeAll(),e&&e.length>0&&(this._agentSpecifications.push(...e),this._selectedAgentSpecification||(this._agentSpecificationServiceErrorMessage.value=H.AgentSpecificationRequired)),this._runButtonDisabled.value=!!this._agentSpecificationServiceErrorMessage.value})).catch((e=>{this._agentSpecifications.removeAll(),e&&e.message&&(this._agentSpecificationServiceErrorMessage.value=e.message)})).then((()=>{this._isLoadingAgentSpecifications.value=!1,this.setState(this._getState())}))}_getSaveCommentContent(){return this.props.isSaveEnabled?l.createElement(l.Fragment,null,l.createElement("div",{className:"flex-column"},l.createElement("label",{className:"label"},H.SaveComment),l.createElement(v.TextField,{ariaLabel:H.SaveComment,value:this._saveCommentText,onChange:this._onSaveCommentChange,ref:this._commentTextFieldRef})),l.createElement("hr",null)):null}_getAgentPools(){return l.createElement(d.Observer,{agentSpecifications:this._agentSpecifications,errorMessage:this._agentSpecificationServiceErrorMessage,isLoading:this._isLoadingAgentSpecifications},(e=>l.createElement(L.AgentQueueSelector,{agentSpecifications:[...e.agentSpecifications],autoFocus:!this.props.isSaveEnabled,isLoadingAgentSpecifications:e.isLoading,selectedAgentSpecification:this.state.selectedAgentSpecification,onAgentSpecificationSelected:this._onSelectedAgentSpecificationChanged,agentSpecificationErrorMessage:e.errorMessage,label:H.AgentPool,agentQueues:this.state.queues,selectedQueue:this._selectedAgentQueue,onAgentChanged:this._onSelectedQueueChanged})))}_getBranchControl(){const e=this._buildDefinition?this._buildDefinition.repository:void 0,t=e&&e.properties&&e.properties.connectedServiceId||"",s=this.props.buildRepository.type===a.RepositoryTypes.TfsVersionControl?H.SourceVersionLabel:H.BranchLabel,i=this.state.sourceVersion,r=!!this._buildDefinition&&this._buildDefinition.process.type===o.YamlProcessType,n=this._isTfsGit?H.TfsGitSourceSelectorDescription:H.GitSourceSelectorDescription;return l.createElement(V.BranchDropdown,{className:"flex-column label margin-bottom-16",ariaLabel:s,label:s,autoFocus:r&&!this.props.isSaveEnabled,repositoryType:this.props.buildRepository.type,repositoryId:this.props.buildRepository.id,defaultBranch:this._normalizeBranchName(this.props.sourceBranch),description:n,connectionId:t,sourceVersion:i,shelvesetName:this.state.shelvesetName,currentCommit:this.state.currentCommit,onBranchSelected:this._branchSelected,onBranchSelectedForCommit:this._branchSelectedForCommit,onError:this._onFetchRepoError,onVersionSelected:this._versionSelected,onTagSelected:this._tagSelected,onShelvesetSelected:this._shelvesetSelected,viewCommits:!0,viewTags:!0,pageContext:this.props.pageContext,actionHub:this._shelvesetPickerActionHub,isDrodownFullWidth:!0,showBranchPickerOnCommitSelected:!0,dropdownMinHeight:29})}_getRunButtonText(){return this.props.isSaveEnabled?"Warning"!==this.state.messageSeverity?H.SaveAndQueueButtonText:H.SaveAndRunWithWarningsButtonText:"Warning"!==this.state.messageSeverity?H.QueueButtonText:H.RunWithWarningsButtonText}_publishQueueBuildTelemetry(){const e=this._queueBuildStore.getDemandsValues(),t=this._queueBuildStore.getVariables(),s={};s.variablesCount=t?t.length:0,s.customDemandsCount=e?e.length:0,s.buildDefinitionId=this.props.definitionId;this.props.pageContext.getService("IVssTelemetryService").publishEvent("Build","queueBuild",s)}_normalizeBranchName(e){return e&&e.startsWith(s)?e.substr(s.length):e&&e.startsWith(i)?e.substr(i.length):e||""}}t.QueuePanel.QueuePanel=o,o.YamlProcessType=2}()}),["Resources","Action","Constants","Stores/QueueBuild","BuildResourcePanel","ContainerResourcePanel","FormInputLabel","DemandPanel","DemandsControllerView","PackageResourcePanel","PipelineResourcePanel","RepositoryResourcePanel","ResourcesControllerView","StageOptionsControllerView","TemplateParametersView","VariablePanel","VariablesControllerView","QueuePanel"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.queue-panel"}}));