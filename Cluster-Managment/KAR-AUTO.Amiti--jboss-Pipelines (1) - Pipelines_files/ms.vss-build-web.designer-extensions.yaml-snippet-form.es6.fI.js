"use strict";define("Build/DesignerExtensions/YamlSnippetForm",["require","exports","VSS/Core/Util/String","DistributedTask/Client/RestClient/TaskAgent","ServiceEndpoints/Client/RestClient/ServiceEndpoint","ServiceEndpoints/Client/Constants/ServiceEndpoint","Build/DesignerExtensions/YamlAssistantLibrary/Contracts/Constants","VSS/Platform/Util/Cookie","react","VSSUI/Util","VSSUI/Callout","VSSUI/Icon","VSSUI/Utilities/ScreenSize","VSS/Features/Markdown/MarkdownRendererComponent","VSSUI/Spinner","VSSUI/Button","VSSUI/Dropdown","VSSUI/Utilities/DropdownSelection","VSSUI/Utilities/GroupedItemProvider","VSS/Core/Observable","VSSUI/FormItem","VSSUI/EditableDropdown","VSSUI/ListBox","VSS/Core/Util/Object","VSSUI/RadioButton","Pipelines/Common/Library/Contracts/Constants","VSSUI/Checkbox","VSSUI/TextField","Build/Flux/Store","DistributedTask/Common/AadAuthorizer/AadAuthorizer","Tfs/Platform/Page","VSS/Platform/Layout","markdown-it","VSSUI/Accordion","VSSUI/FocusZone","VSSUI/Link"],(function(e,t,i,s,n,r,o,a,p,l,u,c,d,h,m,g,S,_,b,C,y,v,f,E,I,V,N,x,T,D,w,k,A,R,P,z){var B,L,M,O,F,G,j,U,q,K,W,Y,H,$;B=t.Resources={},t.Resources.Authorize="Authorize",t.Resources.Authorizing="Authorizing...",t.Resources.Connecting="Connecting...",t.Resources.InvalidBooleanValue="Invalid boolean value: `{0}`, allowed empty, `true` or `false`",t.Resources.NeedsAuthorizing="This subscription requires authorization",t.Resources.AzureSubscriptionPanelTitle="Azure service connection",t.Resources.Connect="Connect",t.Resources.Cancel="Cancel",t.Resources.FailedToFindSnippet="Could not find task for {0}",t.Resources.FailedToFindServiceConnection="Failed to connect to {0}",t.Resources.AddSnippetYaml="Add",t.Resources.CancelSnippetYaml="Cancel",t.Resources.AzureConnectionGroupTitle="Service connections",t.Resources.AzureSubscriptionGroupTitle="Subscriptions",t.Resources.AzureConnectionsEmptyMessage="No subscription or service connection found",t.Resources.FailedToLoadSnippet="Error loading task: {0}",t.Resources.NoServiceConnections="No existing service connections of the appropriate type could be found",t.Resources.NoResultsFound="No results found",t.Resources.InformationButton="Information",t.Resources.NoAzureRMResults="No Azure service connections or subscriptions could be found",t.Resources.CreateRMTimeout="Timed out waiting for the service connection to be ready",t.Resources.TaskReference="About this task",t.Resources.UnsupportedSnippetMessage="The guide for this task is not yet supported, but you can add an outline for it.",t.Resources.AddSnippetOutlineYaml="Add outline",t.Resources.ProjectInfoNotFound="Could not find information for the project selected",t.Resources.ResourcesCannotBeCreated="Kubernetes resources cannot be created. Please review the template definition.",t.Resources.UnknownDatasourceError="Unknown datasource error",t.Resources.EndpointNotFound="The endpoint {0} cannot be found or has been deleted. Please retry the pipeline creation.",function(e){L=t[e]={};t[e].SnippetFormSource=class{constructor(e,t){this._sleepTimeAwaitingEndpoint=1e3,this._dtClient=(0,s.getTaskAgentClient)(e),this._serviceEndpointClient=(0,n.getServiceEndpointClient)(e),this._telemetryService=e.getService("IVssTelemetryService");const i=e.getService("ITfsPageService");this._projectId=i.getData().project.id,this._getInputType=t}async getAzureSubscriptions(){return this._dtClient.getAzureSubscriptions().then((e=>e.value))}async getServiceConnections(e){let t;if(e.indexOf(":")>0){let i=e.split(":");e=i[0],t=i[1].split(",")}return this._dtClient.getServiceEndpoints(this._projectId,e,t,undefined,undefined)}async createAzureRMConnection(e){this._telemetryService&&this._telemetryService.publishEvent(o.TelemetryConstants.Area,o.TelemetryConstants.createAzureRM,{});const t={authorization:{parameters:{authenticationType:r.AzureEndpointConstants.spnKeyAuthType,tenantId:e.subscriptionTenantId},scheme:r.EndpointAuthorizationSchemes.ServicePrincipal},data:{creationMode:r.AzureEndpointConstants.SpnCreationModeAutomatic,environment:r.AzureEndpointConstants.DefaultAzureEnvironment,scopeLevel:r.AzureEndpointConstants.SubscriptionString,subscriptionId:e.subscriptionId,subscriptionName:e.displayName},type:o.AzureRMConnectionType,name:e.displayName+"("+e.subscriptionId+")"};const i=await this._dtClient.createServiceEndpoint(t,this._projectId);return this._returnEndpointWhenReady(i.id)}async getDataSourceResources(e,t,s,n,r){if(o.InternalDataSources[e.type])t=o.InternalDataSources[e.type];else if(!i.isGuid(t)){t=await this._findEndpointByName(t,this._getInputType&&this._getInputType(e.dataSourceDependency))||t}const a={dataSourceDetails:{dataSourceName:e.dataSourceBinding.dataSourceName,dataSourceUrl:e.dataSourceBinding.endpointUrl,headers:[],resourceUrl:"",requestContent:e.dataSourceBinding.requestContent,requestVerb:e.dataSourceBinding.requestVerb,resultSelector:e.dataSourceBinding.resultSelector,initialContextTemplate:e.dataSourceBinding.initialContextTemplate,parameters:Object.assign(Object.assign({},e.dataSourceBinding.parameters),n)},resultTransformationDetails:{resultTemplate:e.dataSourceBinding.resultTemplate,callbackContextTemplate:e.dataSourceBinding.callbackContextTemplate,callbackRequiredTemplate:e.dataSourceBinding.callbackRequiredTemplate},serviceEndpointDetails:s};e.dataSourceDependency&&(a.dataSourceDetails.parameters[e.dataSourceDependency]=t);let p=[];p=await this._getServiceEndpointResult(a,t,p,r);let l={};return p&&p.length>0&&p.forEach((e=>{try{const t=JSON.parse(e);t.DisplayValue&&t.Value?l[t.Value]=t.DisplayValue:t.id&&t.name?l[t.id]=t.name:l[e]=e}catch(t){l[e]=e}})),l}async _findEndpointByName(e,t){let i=await this._serviceEndpointClient.getServiceEndpointsByNames(this._projectId,[e],t);return i.length?(i.length>1&&this._telemetryService&&this._telemetryService.publishEvent(o.TelemetryConstants.Area,o.TelemetryConstants.FindEndpointByName,{endpoints:i.map((e=>({id:e.id,name:e.name,description:e.description,isReady:e.isReady,groupScopeId:e.groupScopeId,type:e.type})))}),i[0].id):void(this._telemetryService&&this._telemetryService.publishEvent(o.TelemetryConstants.Area,o.TelemetryConstants.FindEndpointByName,{endpoints:[]}))}async _getServiceEndpointResult(e,t,i,s){if(!s){const i=await this._serviceEndpointClient.executeServiceEndpointRequest(e,this._projectId,t),s=parseInt(i.statusCode);if(i.errorMessage&&404!==s)throw new Error(i.errorMessage);return i.result}const n=await this._serviceEndpointClient.executeServiceEndpointRequest(e,this._projectId,t);if(n.errorMessage){if(0==i.length)throw new Error(n.errorMessage)}else{const e=n.result;e&&e.length>0&&(i=i.concat(e))}return n.callbackRequired&&(Object.assign(e.dataSourceDetails.parameters,n.callbackContextParameters),i=await this._getServiceEndpointResult(e,t,i,s)),i}async _returnEndpointWhenReady(e){let t=await this._dtClient.getServiceEndpointDetails(this._projectId,e);let i=0;for(;!t.isReady;){if(t.operationStatus&&"Failed"===t.operationStatus.state)throw new Error(t.operationStatus.statusMessage);if(i>=120)throw new Error(B.CreateRMTimeout);i++,await this._sleep(this._sleepTimeAwaitingEndpoint),t=await this._dtClient.getServiceEndpointDetails(this._projectId,e)}return t}async _sleep(e){return new Promise((t=>setTimeout(t,e)))}_getDebugSubscriptions(){if(!this._debugSubscriptions){this._debugSubscriptions=[];for(let e=1;e<10;++e)this._debugSubscriptions.push({displayName:"sub "+e,subscriptionId:""+e,subscriptionTenantId:"tenant"+e,subscriptionTenantName:"tenant "+e})}return this._debugSubscriptions}_getDebugServiceConnections(){if(!this._debugServiceConnections){this._debugServiceConnections=[];for(let e=1;e<10;++e)this._debugServiceConnections.push({name:"sc "+e,id:"sc"+e})}return this._debugServiceConnections}}}("SourcesSnippetFormSource"),function(e){M=t[e]={};let i=1;class s extends p.Component{constructor(e){super(e),this._calloutId="enhancedlabelcallout-"+i++,this._showCallout=e=>{this.setState({showCallout:!0,anchorElement:e.currentTarget})},this._hideCallout=()=>{this.setState({showCallout:!1})},this._onClick=e=>{this._blockCallout||this._showCallout(e)},this._onKeypress=e=>{13!==e.which&&32!==e.which||this._showCallout(e)},this._onMouseDown=e=>{this._blockCallout=this.state.showCallout},this.state={showCallout:!1}}render(){return p.createElement("span",{className:(0,l.css)("enhancedlabel inline-flex-row",this.props.className)},p.createElement("span",{className:(0,l.css)(this.props.isRequired&&"enhancedlabel-required")},this.props.title),this.props.documentation&&p.createElement("span",{className:"enhancedlabel-documentation",tabIndex:0,onClick:this._onClick,onMouseDown:this._onMouseDown,onKeyPress:this._onKeypress,role:"button","aria-label":this.props.ariaLabel||B.InformationButton},p.createElement(c.Icon,{className:"no-padding",iconName:"Info"})),this.state.showCallout&&this.state.anchorElement&&p.createElement(d.ScreenSizeObserver,null,(e=>{const t=e.screenSize<=1?0:8;return p.createElement(u.Callout,{className:"enhancedlabel-documentation-callout",anchorElement:this.state.anchorElement,anchorOffset:{vertical:t,horizontal:t},anchorOrigin:{horizontal:"start",vertical:"end"},calloutOrigin:{horizontal:"center",vertical:"start"},id:this._calloutId,key:this._calloutId,role:"tooltip",onDismiss:this._hideCallout,blurDismiss:!0,escDismiss:!0,focuszoneProps:{focusOnMount:!0,defaultActiveElement:".enhancedlabel-documentation-callout-focusbox",circularNavigation:!0}},p.createElement("div",{className:"enhancedlabel-documentation-callout-focusbox",tabIndex:0},p.createElement(h.MarkdownRendererComponent,{className:"enhancedlabel-documentation-callout-content depth-16",rawContent:this.props.documentation,options:{breaks:!0,html:!0,hideExternalImageIcon:!0}})))})))}}t[e].EnhancedLabel=s}("ComponentsEnhancedLabel"),function(e){O=t[e]={};const i="connections",s="subscriptions";class n extends p.PureComponent{constructor(e){super(e),this._error=new C.ObservableValue(!1),this._message=new C.ObservableValue(void 0),this._selection=new _.DropdownSelection,this._itemProvider=new b.GroupedItemProvider([],[{id:i,loading:!0,name:B.AzureConnectionGroupTitle},{id:s,loading:!0,name:B.AzureSubscriptionGroupTitle}],!0),this._onSelectionChanged=(e,t)=>{t.groupId===s?(this._error.value=!1,this._message.value=B.NeedsAuthorizing,this.setState({authorizing:!1,needAuthorizing:!0})):t.groupId===i&&(this._error.value=!1,this._message.value=void 0,this.props.onValueChanged(this.props.inputDefinition.name,t.id,t.text),this.setState({authorizing:!1,needAuthorizing:!1}))},this._onAuthorize=async()=>{try{if(!this._selection.selectedCount)return Promise.resolve(void 0);const e=this._itemProvider.value[this._selection.value[0].beginIndex];if(!e.data)return Promise.resolve(void 0);const t=e.data;this.setState({authorizing:!0});let s=Object.assign({},t),n=this._getSubscriptionDisplayName(s),r=1;const o=this._itemProvider.value.filter((e=>e.groupId===i)).map((e=>e.text));for(;o.indexOf(n)>=0;)s.displayName=t.displayName+"("+r+")",n=this._getSubscriptionDisplayName(s),r++;const a=await this.props.serviceConnectionProvider.createAzureRMConnection(s);this._itemProvider.push({id:a.id,text:a.name,groupId:i,data:a}),this._selection.select(this._itemProvider.value.findIndex((e=>e.id===a.id))),this.props.onValueChanged(this.props.inputDefinition.name,a.id,a.name),this._error.value=!1,this._message.value=void 0,this.setState({authorizing:!1,needAuthorizing:!1})}catch(e){this._error.value=!0,this._message.value=e.message,this.setState({authorizing:!1}),this.props.onError("AzureSubscriptionPickList._onAuthorize",e)}},this._initiallySelectedName=this.props.getValue(this.props.inputDefinition.name),this.state={authorizing:!1,needAuthorizing:!1}}render(){const e=this.state.needAuthorizing,t=this.state.authorizing?B.Authorizing:B.Authorize,i=this.state.authorizing,s=this.props.inputDefinition;return p.createElement("div",{className:"flex-column"},p.createElement(y.FormItem,{message:this._message,error:this._error,label:p.createElement(M.EnhancedLabel,{title:s.label,isRequired:s.required,documentation:s.helpMarkdown})},p.createElement(S.Dropdown,{noItemsText:B.NoAzureRMResults,items:this._itemProvider,selection:this._selection,onSelect:this._onSelectionChanged})),e&&p.createElement(g.Button,{className:"authorize-button flex-self-start",onClick:this._onAuthorize,primary:!0,disabled:this.state.authorizing},i&&p.createElement(m.Spinner,{size:"small"}),t))}componentDidMount(){this._loadSubscriptions()}async _loadSubscriptions(){try{const e=this.props.serviceConnectionProvider.getAzureSubscriptions(),t=this.props.serviceConnectionProvider.getServiceConnections(o.AzureRMConnectionType),i=await e,s=await t;this._buildConnectionOptions(i,s)}catch(e){this._error.value=!0,this._message.value=e.message,this.props.onError("AzureSubscriptionPickList._loadSubscriptions",e)}}_buildConnectionOptions(e,t){let n=t.map((e=>({id:e.id,text:e.name,groupId:i,data:e})));this._initiallySelectedName&&!n.find((e=>e.text===this._initiallySelectedName))&&n.push({id:this._initiallySelectedName,text:this._initiallySelectedName,groupId:i,data:void 0}),n.sort(((e,t)=>e.text.localeCompare(t.text)));let r=e.map((e=>({id:e.subscriptionId,text:this._getSubscriptionDisplayName(e),groupId:s,data:e})));r.sort(((e,t)=>e.text.localeCompare(t.text))),this._itemProvider.removeAll(),n&&(this._itemProvider.pushGroups({id:i,name:B.AzureConnectionGroupTitle}),this._itemProvider.push(...n)),r&&(this._itemProvider.pushGroups({id:s,name:B.AzureSubscriptionGroupTitle}),this._itemProvider.push(...r)),this._initiallySelectedName&&this._selection.select(this._itemProvider.value.findIndex((e=>e.text===this._initiallySelectedName||e.id===this._initiallySelectedName)))}_getSubscriptionDisplayName(e){return e.displayName+"("+e.subscriptionId+")"}}t[e].AzureSubscriptionPickList=n}("ComponentsAzureSubscriptionPickList"),function(e){F=t[e]={};class i extends p.PureComponent{constructor(e){if(super(e),this._items=new C.ObservableArray,this._message=new C.ObservableValue(void 0),this._error=new C.ObservableValue(!1),this._loadingItem={id:"loading",type:4,render:(e,t,i,s)=>p.createElement(f.LoadingCell,{key:e,columnIndex:t,tableColumn:i,tableItem:s,onMount:this._onLoadingMount})},this._onSelect=()=>{let e=[],t=[];for(let i=0;i<this._selection.value.length;i++){let s=this._selection.value[i].beginIndex,n=this._selection.value[i].endIndex;for(let i=s;i<=n;i++)e.push(this._items.value[i].id),t.push(this._items.value[i].text)}this._onValueChangeInternal(e.join(", "),t.join(", "))},this._onValueChange=e=>{if(e){const t=this._items.value.find((t=>t.id===e.id));t?this._onValueChangeInternal(t.id,t.text||t.id):this._onValueChangeInternal(e.id,e.id)}},this._onLoadingMount=async()=>{try{if(this._items.value=await this.props.loadItems(),this._error.value=!1,this._message.value=void 0,this._selection.clear(),this._initialValues){(this._allowMultiselection?this._initialValues.split(","):[this._initialValues]).forEach((e=>{e=e.trim(),this._items.value.find((t=>t.text===e||t.id===e))||this._items.push({id:e,text:e})}))}const e=this.props.getValue(this.props.inputDefinition.name);if(e){(this._allowMultiselection?e.split(","):[e]).forEach((e=>{e=e.trim();const t=this._items.value.findIndex((t=>t.text===e||t.id===e));t>=0&&this._selection.select(t)}))}}catch(e){this._items.value=[],this._error.value=!0,this._message.value=e.message,this._selection.clear(),this.props.onError&&this.props.onError(this.props.errorContext||"",e)}},this._onExpand=()=>{this.props.loadItems&&(this._error.value||this.props.alwaysRefresh)&&(this._items.removeAll(),this._items.push(this._loadingItem))},this._allowMultiselection=s(e.inputDefinition.properties),this._editable=n(e.inputDefinition.properties),this._allowMultiselection&&(this._editable=!1),this._selection=this._allowMultiselection&&new _.DropdownMultiSelection||new _.DropdownSelection,this._initialValues=e.getValue(e.inputDefinition.name),e.loadItems)this._items.push(this._loadingItem);else{let t=Object.keys(e.inputDefinition.options).map((t=>({id:t,text:e.inputDefinition.options[t]}))),i=e.getValue(this.props.inputDefinition.name);if(""!==i){(this._allowMultiselection?i.split(","):[i]).forEach((e=>{e=e.trim(),void 0===t.find((t=>t.id===e))&&t.push({id:e,text:e});const i=t.findIndex((t=>t.id===e));i>=0&&this._selection.select(i)}))}else this.props.inputDefinition.defaultValue;this._items.change(0,...t)}}render(){const e=this.props.inputDefinition,t={noItemsText:B.NoResultsFound,items:this._items,selection:this._selection,onExpand:this._onExpand,placeholder:this.props.loadItems&&this._initialValues,required:e.required};return p.createElement(y.FormItem,{message:this._message,error:this._error,label:p.createElement(M.EnhancedLabel,{title:e.label,isRequired:e.required,documentation:e.helpMarkdown})},this._editable&&p.createElement(v.EditableDropdown,Object.assign({},t,{allowFreeform:!0,onValueChange:this._onValueChange})),!this._editable&&p.createElement(S.Dropdown,Object.assign({},t,{onSelect:this._onSelect})))}componentDidMount(){this.props.loadOnMount&&this.props.loadItems&&this._onLoadingMount()}_onValueChangeInternal(e,t){this.props.onValueChanged(this.props.inputDefinition.name,e,this.props.useValueAliases&&t||void 0)}}function s(e){if(e){if(e.MultiSelectFlatList&&"true"===e.MultiSelectFlatList.toLowerCase())return!0;if(e.MultiSelect&&"true"===e.MultiSelect.toLowerCase())return!0}return!1}function n(e){return!(!e||!e.EditableOptions||"true"!==e.EditableOptions.toLowerCase())}t[e].EnhancedDropdown=i,t[e].allowsMultiSelect=s,t[e].allowEditable=n}("ComponentsEnhancedDropdown"),function(e){G=t[e]={};class i extends p.Component{constructor(){super(...arguments),this._loadItems=async()=>{const e=this.props.getValue(this.props.inputDefinition.dataSourceDependency),t=this._getParameters(),i=e+Object.keys(t).map((e=>t[e]));return i===this._lastCheckedDependencies&&this._cachedPromise||(this._lastCheckedDependencies=i,this._cachedPromise=this._loadItemsInternal(e,t)),this._cachedPromise},this._loadItemsInternal=async(e,t)=>{const i=await this.props.serviceConnectionProvider.getDataSourceResources(this.props.inputDefinition,e,this.props.serviceEndpointDetails,t,this.props.makeRecursiveDatasourceCalls);let s=[];return Object.keys(i).forEach((e=>{s.push({id:e,text:i[e]})})),s.sort(((e,t)=>e.text.localeCompare(t.text))),s}}render(){return p.createElement(F.EnhancedDropdown,{inputDefinition:this.props.inputDefinition,onValueChanged:this.props.onValueChanged,getValue:this.props.getValue,loadItems:this._loadItems,loadOnMount:this.props.preloadItems,alwaysRefresh:!0,onError:this.props.onError,errorContext:"DataSourcePickList"})}_getParameters(){const e=this._extractDependentParametersFromUrl(this.props.inputDefinition.dataSourceBinding.endpointUrl),t=Object.assign(Object.assign({},e),this.props.inputDefinition.dataSourceBinding.parameters);return Object.keys(t).forEach((e=>{let i=t[e];0===i.indexOf("$(")&&(i=this.props.getValue(i.substr(2,i.length-3))),t[e]=i})),t}_extractDependentParametersFromUrl(e){if(e){const t={};for(;;){const i=e.indexOf("$(");if(i<0)break;const s=(e=e.substr(i)).substr(0,e.indexOf(")")+1);t[s.substr(2,s.length-3)]=s,e=e.substr(s.length)}return t}return{}}}t[e].DataSourcePickList=i}("ComponentsDataSourcePickList"),function(e){j=t[e]={};class i extends p.Component{constructor(e){super(e),this._onChange=e=>{this.props.onValueChanged(this.props.inputDefinition.name,e)},this._groupId=(0,E.getId)("yaml-snippet-panel-radiogroup"),this._initialValue=e.getValue(e.inputDefinition.name)}render(){let e=this.props.getValue(this.props.inputDefinition.name),t=this.props.direction?this.props.direction:2;return p.createElement("div",{className:"flex-column"},p.createElement(y.FormItem,{label:p.createElement(M.EnhancedLabel,{title:this.props.inputDefinition.label,isRequired:this.props.inputDefinition.required,documentation:this.props.inputDefinition.helpMarkdown})},p.createElement(I.RadioButtonGroup,{className:(0,l.css)(this.props.inputDefinition.required&&"required"),selectedButtonId:e,onSelect:this._onChange,id:this._groupId,direction:t},this._radioButtons())))}_radioButtons(){let e=[];return Object.keys(this.props.inputDefinition.options).forEach((t=>{e.push(p.createElement(I.RadioButton,{key:t,id:t,text:this.props.inputDefinition.options[t]}))})),this.props.inputDefinition.options[this._initialValue]||e.push(p.createElement(I.RadioButton,{key:this._initialValue,id:this._initialValue,text:this._initialValue})),e}}t[e].RadioGroup=i}("ComponentsRadioGroup"),function(e){U=t[e]={};class i extends p.Component{constructor(){super(...arguments),this._loadConnections=async()=>{const e=await this.props.serviceConnectionProvider.getServiceConnections(this.props.connectionType);let t=[];return e.forEach((e=>{t.push({id:e.id,text:e.name})})),t.sort(((e,t)=>e.text.localeCompare(t.text))),t}}render(){return p.createElement(F.EnhancedDropdown,{inputDefinition:this.props.inputDefinition,onValueChanged:this.props.onValueChanged,getValue:this.props.getValue,useValueAliases:!0,loadItems:this._loadConnections,loadOnMount:!0,onError:this.props.onError,errorContext:"ServiceConnectionPickList"})}}t[e].ServiceConnectionPickList=i}("ComponentsServiceConnectionPickList"),function(e){q=t[e]={},t[e].unsupportedInputs=function(e){const t=[];return e.forEach((e=>{e.type===V.InputTypes.BOOL||e.type===V.InputTypes.STRING||e.type===V.InputTypes.PICKLIST||e.type===V.InputTypes.RADIO||e.type===V.InputTypes.INT||e.type===V.InputTypes.MULTILINE||0===e.type.indexOf(o.DataSourcePrefix)||0===e.type.indexOf(o.ConnectedServicePrefix)||o.InternalDataSources[e.type]||t.push(e.type)})),t};class s extends p.Component{render(){if(!this.props.isVisible)return null;const e=this.props.snippetInput,t=this.props.getValue(e.name);let s={message:"",isValid:!0};if("validation"in e&&"function"==typeof e.validation){s=e.validation()}switch(e.type){case V.InputTypes.BOOL:{const s=t===e.defaultValue||"true"===t||"false"===t;let n=e.helpMarkdown;return s||(n=`> ${(0,i.format)(B.InvalidBooleanValue,t)}\n\n${n}`),p.createElement("span",{className:"inline-flex-row flex-center"},p.createElement(N.Checkbox,{className:(0,l.css)(e.required&&"required","yaml-snippet-checkbox"),label:e.label,checked:"true"===t,disabled:!s,onChange:(t,i)=>this.props.onValueChanged(e.name,i?"true":"false")}),p.createElement(M.EnhancedLabel,{title:"",isRequired:e.required,documentation:n}))}case V.InputTypes.FILEPATH:case V.InputTypes.STRING:case V.InputTypes.INT:return p.createElement(y.FormItem,{error:!s.isValid,severity:s.severity,message:s.message,label:p.createElement(M.EnhancedLabel,{title:e.label,isRequired:e.required,documentation:e.helpMarkdown})},p.createElement(x.TextField,{value:t,required:e.required,onChange:(t,i)=>this.props.onValueChanged(e.name,i),autoFocus:s.shouldFocusOnElement}));case V.InputTypes.MULTILINE:return p.createElement(y.FormItem,{label:p.createElement(M.EnhancedLabel,{title:e.label,isRequired:e.required,documentation:e.helpMarkdown})},p.createElement(x.TextField,{className:"snippet-multiline",value:t,required:e.required,multiline:!0,autoAdjustHeight:!0,rows:3,onChange:(t,i)=>this.props.onValueChanged(e.name,i)}));case V.InputTypes.PICKLIST:return p.createElement(F.EnhancedDropdown,{inputDefinition:this.props.snippetInput,getValue:this.props.getValue,onValueChanged:this.props.onValueChanged});case V.InputTypes.RADIO:return p.createElement(j.RadioGroup,{inputDefinition:e,onValueChanged:this.props.onValueChanged,getValue:this.props.getValue})}if(0===e.type.indexOf(o.DataSourcePrefix)||o.InternalDataSources[e.type])return p.createElement(G.DataSourcePickList,{inputDefinition:e,serviceConnectionProvider:this.props.serviceConnectionProvider,onValueChanged:this.props.onValueChanged,getValue:this.props.getValue,onError:this.props.onError});if(0===e.type.indexOf(o.ConnectedServicePrefix)){const t=e.type.substr(o.ConnectedServicePrefix.length).toLowerCase();return t===o.AzureRMConnectionType?p.createElement(O.AzureSubscriptionPickList,{inputDefinition:e,serviceConnectionProvider:this.props.serviceConnectionProvider,getValue:this.props.getValue,onValueChanged:this.props.onValueChanged,onError:this.props.onError}):p.createElement(U.ServiceConnectionPickList,{inputDefinition:e,connectionType:t,serviceConnectionProvider:this.props.serviceConnectionProvider,getValue:this.props.getValue,onValueChanged:this.props.onValueChanged,onError:this.props.onError})}return p.createElement(y.FormItem,{label:p.createElement(M.EnhancedLabel,{title:e.label,isRequired:e.required,documentation:e.helpMarkdown})},p.createElement(x.TextField,{value:t,required:e.required,onChange:(t,i)=>this.props.onValueChanged(e.name,i)}))}}t[e].SnippetInput=s}("ComponentsSnippetInput"),function(e){K=t[e]={};class i extends p.Component{render(){return p.createElement("div",{className:(0,l.css)("snippet-input-group flex-column",this.props.className)},this.props.inputs.map((e=>p.createElement(q.SnippetInput,{key:e.name,snippetInput:e,isVisible:this.props.inputValueProvider.isVisible(e.name),onValueChanged:this.props.inputValueProvider.setValue,getValue:this.props.inputValueProvider.getValue,serviceConnectionProvider:this.props.serviceConnectionProvider,onError:this.props.onError}))))}}t[e].SnippetInputList=i;class s{constructor(e,t,i,s,n,r,o){this.groupKey=e,this.groupTitle=t,this.isCollapsed=i,this.inputs=s,this.inputValueProvider=n,this.serviceConnectionProvider=r,this.onError=o}get key(){return this.groupKey}get title(){return this.groupTitle}onRenderContent(){return p.createElement(i,{inputs:this.inputs,inputValueProvider:this.inputValueProvider,serviceConnectionProvider:this.serviceConnectionProvider,onError:this.onError})}}t[e].SnippetInputGroup=s,t[e].getSnippetInputGroups=function(e,t,i,n,r,o){const a=[];return t.forEach((t=>{a.push(new s(t.name,t.displayName,i(t.name),e[t.name],n,r,o))})),a}}("ComponentsSnippetInputGroup"),function(e){W=t[e]={};const s="&&",n="||";t[e].VisibilityHelper=class{static getVisibility(e,t){const i=this._getVisibilityRule(e);if(!i)return!0;let n=i.operator===s;for(let e=0,s=i.predicateRules.length;e<s;e++){const s=i.predicateRules[e];if(!s)continue;let r=t(s.inputName);const o=this._getPredicateResult(s,r);n=this._evaluate(n,o,i.operator)}return n}static _getVisibilityRule(e){let t=null;if(e)if(-1!==e.indexOf(s)){let i=e.split(s).map(this._getPredicateRule);t={operator:s,predicateRules:i}}else if(-1!==e.indexOf(n)){let i=e.split(n).map(this._getPredicateRule);t={operator:n,predicateRules:i}}else{t={operator:null,predicateRules:[this._getPredicateRule(e)]}}return t}static _getPredicateRule(e){let t=null,i=/([a-zA-Z0-9 ]+)([!=<>]+)([a-zA-Z0-9. ]+)|([a-zA-Z0-9 ]+(?=NotContains|NotEndsWith|NotStartsWith))(NotContains|NotEndsWith|NotStartsWith)([a-zA-Z0-9. ]+)|([a-zA-Z0-9 ]+(?=Contains|EndsWith|StartsWith))(Contains|EndsWith|StartsWith)([a-zA-Z0-9. ]+)/g.exec(e);return i&&10===i.length&&(t=i[1]?{inputName:i[1].trim(),condition:i[2].trim(),expectedValue:i[3].trim()}:i[4]?{inputName:i[4].trim(),condition:i[5].trim(),expectedValue:i[6].trim()}:{inputName:i[7].trim(),condition:i[8].trim(),expectedValue:i[9].trim()}),t}static _getPredicateResult(e,t){let s=!1,n=t?t.toString().toLowerCase():t;if(e){let r=e.expectedValue?e.expectedValue.toString().toLowerCase():e.expectedValue;switch(e.condition){case"=":case"==":s=n===r;break;case"!=":s=n!==r;break;case"<":s=n<r;break;case">":s=n>r;break;case"<=":s=n<=r;break;case">=":s=n>=r;break;case"Contains":s=!!t&&t.indexOf(r)>=0;break;case"StartsWith":s=!!t&&i.startsWith(t,r,!0);break;case"EndsWith":s=!!t&&i.endsWith(t,r,!0);break;case"NotContains":s=!(t&&t.indexOf(r)>=0);break;case"NotStartsWith":s=!(t&&i.startsWith(t,r,!0));break;case"NotEndsWith":s=!(t&&i.endsWith(t,r,!0))}}return s}static _evaluate(e,t,i){return i===s?e&&t:i===n?e||t:null!==i||t}}}("UtilitiesVisibilityHelper"),function(e){Y=t[e]={};class i extends T.Store{constructor(){super(...arguments),this._inputsByGroup={},this._groupCollapsedState={},this._initiallyExpandedGroupsEvaluated=!1,this._inputsByName={},this._inputValues={},this._inputValueAliases={},this._inputVisibility={},this._groupVisibility={},this.getValuesForExport=()=>{let e={};return this._snippet.inputs.forEach((t=>{(this._snippet.includeInputs.some((e=>e===t.name))||t.required&&this._inputVisibility[t.name]&&t.defaultValue&&(t.groupName===o.UnparentedInputsGroupName||this._groupVisibility[t.groupName]))&&(e[t.name]=t.defaultValue)})),Object.keys(this._inputValues).forEach((t=>{void 0!==this._inputValueAliases[t]&&this._inputValueAliases[t]!==this._inputsByName[t].defaultValue?e[t]=this._inputValueAliases[t]:void 0!==this._inputValues[t]&&this._inputValues[t]!==this._inputsByName[t].defaultValue&&(e[t]=this._inputValues[t])})),Object.keys(this._inputVisibility).forEach((t=>{this._inputVisibility[t]||delete e[t]})),e},this.setValue=(e,t,i)=>{this._inputValues[e]=t,i&&(this._inputValueAliases[e]=i),this._updateVisibilityMaps(),this.emitChanged()},this.getValue=e=>this._inputVisibility[e]?void 0!==this._inputValues[e]?this._inputValues[e]:this._inputsByName[e]&&this._inputsByName[e].defaultValue||"":"",this.isVisible=e=>this._inputVisibility[e],this.isGroupVisible=e=>this._groupVisibility[e],this.isGroupCollapsed=e=>this._groupCollapsedState[e],this.toggleGroup=(e,t)=>{const i=this._groupCollapsedState[t.key].value;this._groupCollapsedState[t.key].value=!i},this.toggleGroupByKey=e=>{const t=this._groupCollapsedState[e].value;this._groupCollapsedState[e].value=!t},this.getInputType=e=>{const t=this._inputsByName[e].type;return t.indexOf(":")>=0?t.split(":").pop():t},this.setInputVisibility=(e,t)=>{this._inputVisibility[e]==!t&&(this._inputVisibility[e]=t,this.emitChanged())}}loadSnippet(e,t){this._snippet=e,this._inputsByGroup={},this._inputsByName={},this._organizeInputs(),t&&this._loadStartingParameters(t),this._updateVisibilityMaps(),this._findInitiallyExpandedGroups(),this._unsupportedInputs=(0,q.unsupportedInputs)(Object.keys(this._inputsByName).map((e=>this._inputsByName[e]))),this.emitChanged()}get visibleGroups(){return this._snippet.groups.filter((e=>this._groupVisibility[e.name]&&this._inputsByGroup[e.name]&&this._inputsByGroup[e.name].length>0))}get snippet(){return this._snippet}get inputsByGroup(){return this._inputsByGroup}get isSnippetSupported(){return 0===this._unsupportedInputs.length}get unsupporedInputTypes(){return this._unsupportedInputs}hasInputType(e){let t,i=!1;if(e.indexOf("prop:")>=0){const i=e.split(" ");t=i.find((e=>e.indexOf("prop:")>=0)).substr(5),e=e.replace("prop:"+t,"").trim()}return Object.keys(this._inputsByName).forEach((s=>{const n=this._inputsByName[s];n.type===e&&(t?n.properties&&n.properties[t]&&"true"===n.properties[t].toLowerCase()&&(i=!0):i=!0)})),i}_organizeInputs(){this._snippet.inputs.forEach((e=>{this._inputsByGroup[e.groupName]||(this._inputsByGroup[e.groupName]=[]),this._inputsByGroup[e.groupName].push(e),this._inputsByName[e.name]=e}))}_updateVisibilityMaps(){this._snippet.inputs.forEach((e=>{this._inputVisibility[e.name]=W.VisibilityHelper.getVisibility(e.visibleRule,this.getValue)})),this._snippet.groups.forEach((e=>{const t=this._inputsByGroup[e.name]||[];0===t.filter((e=>this._inputVisibility[e.name])).length?this._groupVisibility[e.name]=!1:(this._groupVisibility[e.name]=W.VisibilityHelper.getVisibility(e.visibleRule,this.getValue),this._groupVisibility[e.name]||t.forEach((e=>{this._inputVisibility[e.name]=!1})))}))}_findInitiallyExpandedGroups(){this._initiallyExpandedGroupsEvaluated||(this._snippet.groups.forEach((e=>{let t=!1;if(!1===e.isExpanded)t=!0;else{t=e.displayName.trim().toLowerCase().indexOf("advanced")>=0}this._groupCollapsedState[e.name]=new C.ObservableValue(t)})),this._initiallyExpandedGroupsEvaluated=!0)}_loadStartingParameters(e){Object.keys(e).forEach((t=>{let i;this._inputsByName[t]?i=this._inputsByName[t]:this._snippet.inputs.forEach((e=>{e.aliases.indexOf(t)>=0&&(i=e)}));const s=e[t];i&&null!=s&&(this._inputValues[i.name]=s.toString())}))}}t[e].SnippetFormStore=i}("StoresSnippetFormStore"),function(e){var r,o;H=t[e]={};class a{}t[e].EndpointConstants=a,a.AuthSchemes=((r=class{}).docker="Docker",r.kubernetes="Kubernetes",r.servicePrincipal="serviceprincipal",r),a.EndpointTypes=((o=class{}).docker="dockerregistry",o.kubernetes="Kubernetes",o.azureRM="azurerm",o),a.azureEnvironment="AzureCloud",a.azureManagementUrl="https://management.azure.com/";class p{static _getClusterNameFromClusterId(e){let t="";if(e){const i=e.split("/"),s=i.findIndex((e=>"managedClusters"===e))+1;s>0&&(t=i[s])}return t}static async getAuthorizationToken(e,t){const i=(0,s.getTaskAgentClient)(e),n=await i.getVstsAadTenantId();if(t&&n&&n.toLocaleLowerCase()!=t.subscriptionAccount.subscriptionTenantId.toLocaleLowerCase()){const i=new D.AadAuthorizer(e),s=(0,w.getTFSPageData)(e);if(s&&s.project){return await i.getAccessTokenKey(s.project,t.subscriptionAccount.subscriptionTenantId,n)}}}static getAzureRMServiceEndpointDetails(e,t,i){if(!t)return{};let s={accessTokenType:"AppToken",tenantId:t.subscriptionAccount.subscriptionTenantId};i&&(s.accessToken=i,s.accessTokenFetchingMethod=1..toString());return{authorization:{parameters:s,scheme:a.AuthSchemes.servicePrincipal},data:{subscriptionId:t.id,subscriptionName:t.displayName,environment:a.azureEnvironment,scopeLevel:"subscription"},type:a.EndpointTypes.azureRM,url:a.azureManagementUrl}}static getEndpointStatus(e,t){const s=(0,w.getTFSPageData)(t);if(s&&s.project){const r=s.project.name;return new Promise(((s,o)=>{let a=!1,p={state:"InProgress",statusMessage:""};function l(t){o(JSON.stringify({endpointId:e,error:t}))}let u=setTimeout((function o(){a||(0,n.getServiceEndpointClient)(t).getServiceEndpointDetails(r,e).then((t=>{null===t&&(clearTimeout(u),a=!0,l((0,i.format)(B.EndpointNotFound,e))),t.operationStatus&&(p=t.operationStatus),t.isReady?(clearTimeout(u),a=!0,s(p.state)):"Failed"===p.state?(clearTimeout(u),a=!0,l(p.statusMessage)):"InProgress"===p.state&&(u=setTimeout(o,2e3))}),(e=>{clearTimeout(u),a=!0,l(e)}))}),2e3)}))}return Promise.reject(B.ProjectInfoNotFound)}static generateAuxillaryResourcesForEndpoints(e,t,i){let s={};const n=t.k8sConnection,r=e.filter((e=>"environmentresource:kubernetes"===e.type.toLocaleLowerCase()));if(r.length>0){if(!n)return Promise.reject(B.ResourcesCannotBeCreated);for(let e=0;e<r.length;e++){const t={name:n.Data.namespace,namespace:n.Data.namespace,clusterName:p._getClusterNameFromClusterId(n.Data.clusterId),serviceEndpointId:n.Id,tags:[]};s[r[e].name]={resourcetocreate:t,type:r[e].type}}s.environment={resourcetocreate:{name:i.repositoryName,description:`CI/CD setup from this repo: '${i.repositoryName}'`},type:"environment"}}return Promise.resolve(s)}}t[e].EndpointHelper=p}("UtilitiesEndpointHelper"),function(e){$=t.UtilitiesYamlExport={};const i="\r\n",s="    ";t.UtilitiesYamlExport.exportYaml=async function(e,t,n){return Boolean(t.content)?function(e,t,i){const s=e.getService("IVssContributionService"),n="ms.vss-build-web.customized-template-data-provider",r={templateParameters:Object.assign(Object.assign({},i),{templateId:t.id}),validateAssets:!1,branch:"",connectionId:"",repositoryId:"",sourceProviderType:""};return s.getDataAsync(n,r).then((e=>e&&e.content||""))}(e,t,n):function(e,t){let n="- task: "+e.name+"@"+e.version.major+i;e.inputs.length>0&&(n+="  inputs:\r\n");return e.inputs.forEach((e=>{let r=t[e.name];if(void 0!==r){e.type!==V.InputTypes.BOOL&&e.type!==V.InputTypes.INT&&""!==r&&(r=r.trim(),r.indexOf("\n")>0?(r="|\n"+r,r=r.split("\n").join("\r\n      ")):r="'"+r.replace(/'/g,"''")+"'");const t=e.aliases&&e.aliases.length>0&&e.aliases[0]||e.name;n+=s+t+": "+r+i}})),n}(t,n)}}(),function(e){t[e]={};class i extends k.VssComponent{constructor(e,t){super(e,t),this.getValue=e=>"subscriptionId"===e&&this.props.subscription&&this.props.subscription.id?"0":"",this._createServiceEndpointObject=(e,t)=>{let i=JSON.parse(t.replace(/'/g,'"')),s=this.getRegistryNameFromRegistryId(i.id),n={data:{registrytype:"ACR",registryId:i.id,subscriptionId:this.props.subscription?this.props.subscription.id:"",subscriptionName:this.props.subscription?this.props.subscription.displayName:""},name:s,type:H.EndpointConstants.EndpointTypes.docker,url:`https://${i.loginServer}`,authorization:{scheme:H.EndpointConstants.AuthSchemes.servicePrincipal,parameters:{tenantId:this.props.subscription?this.props.subscription.subscriptionAccount.subscriptionTenantId:"",servicePrincipalId:"<placeholder>",scope:i.id,loginServer:i.loginServer}}};this.props.onAllValuesReceived(n)};this.state={registryUrl:""},this._source=new L.SnippetFormSource(this.context.pageContext)}render(){let e={dataSourceBinding:{dataSourceName:"AzureRMContainerRegistries",resultTemplate:"{ \"Value\": \"{'id':'{{id}}', 'name':'{{name}}' , 'loginServer': '{{ properties.loginServer}}'}\", \"DisplayValue\" : \"{{name}}\" }",parameters:{}},dataSourceDependency:"subscriptionId",label:"Container registry",name:"containerRegistry"};const{className:t}=this.props;return p.createElement("div",{className:(0,k.css)("section",t)},p.createElement(G.DataSourcePickList,{inputDefinition:e,serviceConnectionProvider:this._source,onValueChanged:this._createServiceEndpointObject,getValue:this.getValue,onError:this.props.onError,preloadItems:!0,serviceEndpointDetails:H.EndpointHelper.getAzureRMServiceEndpointDetails(this.context.pageContext,this.props.subscription,this.props.endpointToken)}))}componentDidMount(){super.componentDidMount()}getRegistryNameFromRegistryId(e){let t="";if(e){let i=e.split("/"),s=i.findIndex((e=>"registries"===e))+1;s>0&&(t=i[s])}return t}}t[e].AzureContainerRegistryPicker=i}("ComponentsAzureContainerRegistryPicker"),function(e){t[e]={};class i extends k.VssComponent{constructor(e,t){super(e,t),this.onValueChanged=(e,t)=>{if("clusterName"===e){const e=JSON.parse(t.replace(/'/g,'"'));this.setState({clusterId:e.id,fqdn:`https://${e.fqdn}`,clusterName:e.name,namespace:""})}else"namespace"===e?this.setState(Object.assign(Object.assign({},this.state),{namespace:t.toLowerCase()}),(()=>{this.props.onAllValuesReceived(this._createServiceEndpointObject())})):"createNewNamespace"===e&&this.setState(Object.assign(Object.assign({},this.state),{createNewNamespace:t,namespace:""}))},this.getValue=e=>{switch(e){case"createNewNamespace":return this.state.createNewNamespace;case"namespace":return this.state.namespace;case"subscriptionId":return this.props.subscription&&this.props.subscription.id?"0":"";case"clusterName":return this.state.clusterName?this.state.clusterName:"";default:return""}},this._getKubernetesServiceEndpointDetails=()=>{if(this.props.subscription){let e;return e={authorization:{parameters:{azureEnvironment:H.EndpointConstants.azureEnvironment,azureTenantId:this.props.subscription.subscriptionAccount.subscriptionTenantId},scheme:H.EndpointConstants.AuthSchemes.kubernetes},data:{authorizationType:"AzureSubscription",azureSubscriptionId:this.props.subscription.id,azureSubscriptionName:this.props.subscription.displayName,clusterId:this.state.clusterId},type:H.EndpointConstants.EndpointTypes.kubernetes,url:this.state.fqdn},e}},this._createServiceEndpointObject=()=>{if(this.props.subscription){const e={azureEnvironment:"AzureCloud",azureTenantId:this.props.subscription.subscriptionAccount.subscriptionTenantId};return this.props.endpointToken&&(e.azureAccessToken=this.props.endpointToken),{data:{authorizationType:"AzureSubscription",azureSubscriptionId:this.props.subscription.id,azureSubscriptionName:this.props.subscription.displayName,clusterId:this.state.clusterId,namespace:this.state.namespace,"operation.createOrReuseNamespace":this.state.createNewNamespace,clusterAdmin:this.props.clusterAdmin?"true":"false"},name:`${this.state.clusterName}-${this.state.namespace}`,type:"kubernetes",url:this.state.fqdn,authorization:{scheme:"Kubernetes",parameters:e}}}},this._getRadioButtons=()=>[p.createElement(I.RadioButton,{key:"true",className:"namespace-radio-button",id:"true",text:"New"}),p.createElement(I.RadioButton,{key:"false",className:"namespace-radio-button",id:"false",text:"Existing"})];this.state={clusterId:"",namespace:"",fqdn:"",createNewNamespace:"false",clusterName:"",clusterAdmin:!1},this._source=new L.SnippetFormSource(this.context.pageContext)}render(){const e={dataSourceBinding:{dataSourceName:"AzureKubernetesClusters",resultTemplate:"{ \"Value\": \"{'id':'{{id}}', 'fqdn': '{{properties.fqdn}}', 'name': '{{name}}' }\", \"DisplayValue\" : \"{{name}}\" }",parameters:{}},dataSourceDependency:"subscriptionId",label:"Cluster",name:"clusterName"},t={dataSourceBinding:{dataSourceName:"KubernetesNamespaces",resultTemplate:'{ "Value" : "{{metadata.name}}", "DisplayValue" : "{{metadata.name}}" }',parameters:{}},dataSourceDependency:"clusterName",label:"",name:"namespace"};null!=this.props.clusterAdmin&&this.props.clusterAdmin!=this._clusterAdmin&&(this._clusterAdmin=this.props.clusterAdmin,this.onValueChanged("namespace",this.state.namespace));const{className:i}=this.props;return p.createElement("div",{className:"section"},p.createElement("div",{className:i},p.createElement(G.DataSourcePickList,{inputDefinition:e,serviceConnectionProvider:this._source,onValueChanged:this.onValueChanged,getValue:this.getValue,onError:this.props.onError,preloadItems:!0,serviceEndpointDetails:H.EndpointHelper.getAzureRMServiceEndpointDetails(this.context.pageContext,this.props.subscription,this.props.endpointToken),makeRecursiveDatasourceCalls:!0})),p.createElement("div",{className:i},p.createElement("label",{className:"bolt-textfield-label"},"Namespace"),p.createElement(I.RadioButtonGroup,{className:"",selectedButtonId:this.getValue("createNewNamespace"),onSelect:e=>this.onValueChanged("createNewNamespace",e),direction:1},this._getRadioButtons()),"false"===this.state.createNewNamespace&&p.createElement(G.DataSourcePickList,{inputDefinition:t,serviceConnectionProvider:this._source,onValueChanged:this.onValueChanged,getValue:this.getValue,onError:this.props.onError,preloadItems:!!this.state.clusterId,serviceEndpointDetails:this._getKubernetesServiceEndpointDetails()}),"true"===this.state.createNewNamespace&&p.createElement(y.FormItem,{className:"flex-row",label:""},p.createElement(x.TextField,{containerClassName:"namespace-text-field",value:this.getValue("namespace"),onChange:(e,t)=>this.onValueChanged("namespace",t)}))))}componentDidMount(){super.componentDidMount()}}t[e].AzureKubernetesEndpointInput=i}("ComponentsAzureKubernetesEndpointInput"),function(e){t[e]={};class i extends p.Component{constructor(e,t){super(e,t),this.state={},this._renderer=new A({breaks:!0,linkify:!1,typographer:!1,html:!0}),this._renderer.validateLink=n}render(){const e=this._renderer.render(this.props.text);return p.createElement("span",{dangerouslySetInnerHTML:{__html:e}})}}t[e].SimpleMarkdownRenderer=i;const s=/^(vbscript|javascript|file|data):/;function n(e){var t=e.trim().toLowerCase();return!s.test(t)}t[e].validateLinkProtocol=n}("ComponentsSimpleMarkdownRenderer"),function(e){t.SnippetForm={};class s extends k.VssComponent{constructor(e){super(e),this._addSnippetToYaml=()=>{this._export(this._store.getValuesForExport(),o.TelemetryConstants.ExportSnippet)},this._getStateFromStore=()=>{this.setState({snippetInputsByGroup:this._store.inputsByGroup,visibleGroups:this._store.visibleGroups,isSnippetSupported:this._store.isSnippetSupported})},this._onError=(e,t)=>{const i=this.context.pageContext.getService("IVssTelemetryService");i&&i.publishEvent(o.TelemetryConstants.Area,o.TelemetryConstants.Error,{location:e,error:t,snippetName:this.props.snippet.friendlyName})},this.state={snippetInputsByGroup:{},visibleGroups:[],isSnippetSupported:!0}}render(){return p.createElement("div",{className:"yaml-snippet-form flex-column flex-grow",style:this.props.customFormStyles},this._content())}_content(){if(this.state.error&&this.state.error.message)return p.createElement("div",null,p.createElement(g.Button,{className:"yaml-snippet-back-button",onClick:this.props.onDismiss,subtle:!0,iconProps:{iconName:"Back"},ariaLabel:B.CancelSnippetYaml}),p.createElement("span",null,(0,i.format)(B.FailedToLoadSnippet,this.state.error.message)));const e=this.state.snippetInputsByGroup[o.UnparentedInputsGroupName];let t="";return t=this.props.snippet.helpMarkdown?this.props.snippet.description.concat("\n\n",this.props.snippet.helpMarkdown):this.props.snippet.description,p.createElement(p.Fragment,null,p.createElement(P.FocusZone,{focusOnMount:!0},p.createElement("div",{className:(0,l.css)(this.props.className||"yaml-snippet-form-content","flex-grow","v-scroll-auto","h-scroll-hidden")},p.createElement("div",{className:(0,l.css)(this.props.innerContentClassName||"yaml-snippet-form-inner-content")},!this.props.hideHeader&&p.createElement("span",{className:"flex-row snippet-form-header"},p.createElement(g.Button,{className:"yaml-snippet-back-button",onClick:this.props.onDismiss,subtle:!0,iconProps:{iconName:"Back"},ariaLabel:B.CancelSnippetYaml}),p.createElement(M.EnhancedLabel,{className:"snippet-name-header text-ellipsis title-s",title:this.props.snippet.friendlyName,documentation:t})),e&&e.length>0&&p.createElement(K.SnippetInputList,{className:"ungrouped",inputs:e,inputValueProvider:this._store,serviceConnectionProvider:this._source,onError:this._onError}),this.state.visibleGroups.length>0&&p.createElement(R.Accordion,{sections:(0,K.getSnippetInputGroups)(this.state.snippetInputsByGroup,this.state.visibleGroups,this._store.isGroupCollapsed,this._store,this._source,this._onError),onSectionClicked:this._store.toggleGroup})))),!this.props.hideFooter&&p.createElement("div",{className:"yaml-snippet-form-footer"},this.props.snippet.documentationUrl&&p.createElement(z.Link,{className:"snippet-documentation",href:this.props.snippet.documentationUrl,target:"_blank",rel:"noopener noreferrer"},B.TaskReference),p.createElement(g.Button,{primary:!0,onClick:this._addSnippetToYaml},B.AddSnippetYaml)))}componentDidMount(){super.componentDidMount(),this._load()}componentWillUnmount(){super.componentWillUnmount(),this._store&&this._store.dispose()}componentDidUpdate(e,t){e.snippet===this.props.snippet&&e.startingParameters===this.props.startingParameters||this._load()}_load(){this.props.snippet.inputs.length>0?(this._store=this.props.store||new Y.SnippetFormStore,this._store.addListener(this._getStateFromStore),this._source=new L.SnippetFormSource(this.context.pageContext,this._store.getInputType),this._loadSnippet(this.props.snippet,this.props.startingParameters)):this._export({},o.TelemetryConstants.ExportSnippet)}_loadSnippet(e,t){try{if(this._store.loadSnippet(e,t),!this._store.isSnippetSupported){const e=this.context.pageContext.getService("IVssTelemetryService");e&&e.publishEvent(o.TelemetryConstants.Area,o.TelemetryConstants.LoadedUnsupportedSnippet,{name:this.props.snippet.friendlyName,version:this.props.snippet.version,isTemplate:Boolean(this.props.snippet.content),unsupportedInputs:this._store.unsupporedInputTypes.join(",")})}if(Boolean(t)){const t=this.context.pageContext.getService("IVssTelemetryService");t&&t.publishEvent(o.TelemetryConstants.Area,o.TelemetryConstants.SnippetSelected,{name:e.friendlyName,version:e.version,codeLens:!0})}}catch(e){this.setState({error:e});const t=this.context.pageContext.getService("IVssTelemetryService");t&&t.publishEvent(o.TelemetryConstants.Area,o.TelemetryConstants.Error,{location:"loadSnippetForm",error:e})}}async _export(e,t){if(this.props.onInputsCompleted&&this.props.onInputsCompleted(e),this.props.onYamlGenerated){const t=await(0,$.exportYaml)(this.context.pageContext,this.props.snippet,e);this.props.onYamlGenerated(t)}this.props.onDismiss&&this.props.onDismiss();const i=this.context.pageContext.getService("IVssTelemetryService");i&&i.publishEvent(o.TelemetryConstants.Area,t,{name:this.props.snippet.friendlyName,version:this.props.snippet.version,isTemplate:Boolean(this.props.snippet.content)})}}t.SnippetForm.SnippetForm=s,k.Components.add("yaml-snippet-form",s)}()}),["Resources","Sources/SnippetFormSource","Components/EnhancedLabel","Components/AzureSubscriptionPickList","Components/EnhancedDropdown","Components/DataSourcePickList","Components/RadioGroup","Components/ServiceConnectionPickList","Components/SnippetInput","Components/SnippetInputGroup","Utilities/VisibilityHelper","Stores/SnippetFormStore","Utilities/EndpointHelper","Utilities/YamlExport","Components/AzureContainerRegistryPicker","Components/AzureKubernetesEndpointInput","Components/SimpleMarkdownRenderer","SnippetForm"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.designer-extensions.yaml-snippet-form"}}));